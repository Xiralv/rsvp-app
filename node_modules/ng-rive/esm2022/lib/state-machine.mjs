import { EventEmitter, Directive, NgZone, Output, Input, ContentChildren, QueryList, Inject, forwardRef } from '@angular/core';
import { BehaviorSubject, of } from 'rxjs';
import { filter, map, switchMap } from 'rxjs/operators';
import { RiveCanvas } from './canvas';
import { RiveService } from './service';
import * as i0 from "@angular/core";
import * as i1 from "./canvas";
import * as i2 from "./service";
function getInput(input) {
    if (input.type === 56 /* InputTypes.Number */)
        return input.asNumber();
    if (input.type === 59 /* InputTypes.Boolean */)
        return input.asBool();
    if (input.type === 58 /* InputTypes.Trigger */)
        return input.asTrigger();
    return input;
}
function assertStateMachine(animation, artboard, name) {
    if (animation)
        return;
    const artboardName = artboard.name ?? 'Default';
    const count = artboard.stateMachineCount();
    if (typeof name === 'number') {
        throw new Error(`Provided index "${name}" for the animation of artboard "${artboardName}" is not available. Animation count is: ${count}`);
    }
    else {
        const names = [];
        for (let i = 0; i < count; i++) {
            names.push(artboard.stateMachineByIndex(i).name);
        }
        throw new Error(`Provided name "${name}" for the animation of artboard "${artboardName}" is not available. Availables names are: ${JSON.stringify(names)}`);
    }
}
export class RiveSMInput {
    set name(name) {
        if (!name)
            return;
        this._name = name;
        if (this.input)
            return;
        this.init(this.stateMachine.inputs[name]);
    }
    get name() {
        return this.input?.name ?? this._name;
    }
    set value(rawValue) {
        if (typeof rawValue === 'undefined' || rawValue === null)
            return;
        const value = typeof rawValue === 'string'
            ? parseFloat(rawValue)
            : rawValue;
        if (this.input) {
            this.input.value = value;
            this.change.emit(this.input);
        }
        else {
            this._value = value;
        }
    }
    get value() {
        return this.input?.value ?? this._value;
    }
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        this.change = new EventEmitter();
        this.load = new EventEmitter();
    }
    /** @internal: Used by the RiveStateMachine */
    init(input) {
        if (!input || input.name === this.input?.name)
            return;
        this.input = getInput(input);
        this.load.emit(input);
        if (typeof this._value !== 'undefined') {
            this.input.value = this._value;
            this.change.emit(this.input);
        }
        if (this.shouldFire) {
            this.shouldFire(input);
            delete this.shouldFire;
        }
    }
    fire() {
        const fire = (input) => {
            if (input.type === 58 /* InputTypes.Trigger */) {
                input.fire();
                this.change.emit(input);
            }
        };
        this.input
            ? fire(this.input)
            : this.shouldFire = fire;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RiveSMInput, deps: [{ token: forwardRef(() => RiveStateMachine) }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.1.4", type: RiveSMInput, isStandalone: true, selector: "riv-input, [rivInput]", inputs: { name: "name", value: "value" }, outputs: { change: "change", load: "load" }, exportAs: ["rivInput"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RiveSMInput, decorators: [{
            type: Directive,
            args: [{
                    selector: 'riv-input, [rivInput]',
                    exportAs: 'rivInput',
                    standalone: true
                }]
        }], ctorParameters: function () { return [{ type: RiveStateMachine, decorators: [{
                    type: Inject,
                    args: [forwardRef(() => RiveStateMachine)]
                }] }]; }, propDecorators: { name: [{
                type: Input
            }], value: [{
                type: Input
            }], change: [{
                type: Output
            }], load: [{
                type: Output
            }] } });
function exist(v) {
    return v !== undefined && v !== null;
}
export class RiveStateMachine {
    set name(name) {
        if (typeof name !== 'string')
            return;
        this.zone.runOutsideAngular(() => {
            this.register(name);
        });
    }
    set index(value) {
        const index = typeof value === 'string' ? parseInt(value) : value;
        if (typeof index !== 'number')
            return;
        this.zone.runOutsideAngular(() => {
            this.register(index);
        });
    }
    set speed(value) {
        const speed = typeof value === 'string' ? parseFloat(value) : value;
        if (typeof speed === 'number')
            this.update({ speed });
    }
    get speed() {
        return this.state.getValue().speed;
    }
    set play(playing) {
        if (playing === true || playing === '') {
            this.update({ playing: true });
        }
        else if (playing === false) {
            this.update({ playing: false });
        }
    }
    get play() {
        return this.state.getValue().playing;
    }
    constructor(zone, canvas, service) {
        this.zone = zone;
        this.canvas = canvas;
        this.service = service;
        this.state = new BehaviorSubject({ speed: 1, playing: false });
        this.inputs = {};
        this.load = new EventEmitter();
        this.stateChange = new EventEmitter();
    }
    ngOnDestroy() {
        const name = this.instance?.name;
        if (name)
            delete this.canvas.stateMachines[name];
        this.sub?.unsubscribe();
        setTimeout(() => this.instance?.delete(), 100);
    }
    update(state) {
        this.state.next({ ...this.state.getValue(), ...state });
    }
    setInput(input) {
        this.inputs[input.name] = input;
        const riveInput = this.riveInputs?.find(item => item.name === input.name);
        if (riveInput) {
            riveInput.init(input);
        }
    }
    getFrame(state) {
        if (state.playing && this.service.frame) {
            return this.service.frame.pipe(map((time) => [state, time]));
        }
        else {
            return of(null);
        }
    }
    initStateMachine(name) {
        if (!this.canvas.rive)
            throw new Error('Could not load state machine instance before rive');
        if (!this.canvas.artboard)
            throw new Error('Could not load state machine instance before artboard');
        const ref = typeof name === 'string'
            ? this.canvas.artboard.stateMachineByName(name)
            : this.canvas.artboard.stateMachineByIndex(name);
        assertStateMachine(ref, this.canvas.artboard, name);
        // Fetch the inputs from the runtime if we don't have them
        this.instance = new this.canvas.rive.StateMachineInstance(ref, this.canvas.artboard);
        this.canvas.stateMachines[this.instance.name] = this.instance;
        for (let i = 0; i < this.instance.inputCount(); i++) {
            this.setInput(this.instance.input(i));
        }
        this.load.emit(this.instance);
    }
    register(name) {
        // Stop subscribing to previous animation if any
        this.sub?.unsubscribe();
        // Update on frame change if playing
        const onFrameChange = this.state.pipe(switchMap((state) => this.getFrame(state)), filter(exist), map(([state, time]) => (time / 1000) * state.speed));
        // Wait for canvas & animation to be loaded
        this.sub = this.canvas.onReady().pipe(map(() => this.initStateMachine(name)), switchMap(() => onFrameChange)).subscribe((delta) => this.applyChange(delta));
    }
    applyChange(delta) {
        if (!this.instance)
            throw new Error('Could not load state machin instance before running it');
        this.canvas.draw(this.instance, delta);
        // Check for any state machines that had a state change
        const changeCount = this.instance.stateChangedCount();
        if (changeCount) {
            const states = [];
            for (let i = 0; i < changeCount; i++) {
                states.push(this.instance.stateChangedNameByIndex(i));
            }
            this.stateChange.emit(states);
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RiveStateMachine, deps: [{ token: i0.NgZone }, { token: i1.RiveCanvas }, { token: i2.RiveService }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.1.4", type: RiveStateMachine, isStandalone: true, selector: "riv-state-machine, [rivStateMachine]", inputs: { name: "name", index: "index", speed: "speed", play: "play" }, outputs: { load: "load", stateChange: "stateChange" }, queries: [{ propertyName: "riveInputs", predicate: RiveSMInput }], exportAs: ["rivStateMachine"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RiveStateMachine, decorators: [{
            type: Directive,
            args: [{
                    selector: 'riv-state-machine, [rivStateMachine]',
                    exportAs: 'rivStateMachine',
                    standalone: true
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: i1.RiveCanvas }, { type: i2.RiveService }]; }, propDecorators: { riveInputs: [{
                type: ContentChildren,
                args: [RiveSMInput]
            }], load: [{
                type: Output
            }], stateChange: [{
                type: Output
            }], name: [{
                type: Input
            }], index: [{
                type: Input
            }], speed: [{
                type: Input
            }], play: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmctcml2ZS9zcmMvbGliL3N0YXRlLW1hY2hpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFlBQVksRUFDWixTQUFTLEVBQ1QsTUFBTSxFQUVOLE1BQU0sRUFDTixLQUFLLEVBQ0wsZUFBZSxFQUNmLFNBQVMsRUFDVCxNQUFNLEVBQUUsVUFBVSxFQUNuQixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsZUFBZSxFQUFFLEVBQUUsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN0QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7O0FBV3hDLFNBQVMsUUFBUSxDQUFDLEtBQWU7SUFDL0IsSUFBSSxLQUFLLENBQUMsSUFBSSwrQkFBc0I7UUFBRSxPQUFPLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM5RCxJQUFJLEtBQUssQ0FBQyxJQUFJLGdDQUF1QjtRQUFFLE9BQU8sS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzdELElBQUksS0FBSyxDQUFDLElBQUksZ0NBQXVCO1FBQUUsT0FBTyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDaEUsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxTQUF1QixFQUFFLFFBQWtCLEVBQUUsSUFBcUI7SUFDNUYsSUFBSSxTQUFTO1FBQUUsT0FBTztJQUN0QixNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQztJQUNoRCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsaUJBQWlCLEVBQUUsQ0FB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QUEvQyxlQUFlO3VCQUFDLFdBQVc7Z0JBRWxCLElBQUk7c0JBQWIsTUFBTTtnQkFDRyxXQUFXO3NCQUFwQixNQUFNO2dCQUdILElBQUk7c0JBRFAsS0FBSztnQkFTRixLQUFLO3NCQURSLEtBQUs7Z0JBVUYsS0FBSztzQkFEUixLQUFLO2dCQVNPLElBQUk7c0JBQWhCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIEV2ZW50RW1pdHRlcixcclxuICBEaXJlY3RpdmUsXHJcbiAgTmdab25lLFxyXG4gIE9uRGVzdHJveSxcclxuICBPdXRwdXQsXHJcbiAgSW5wdXQsXHJcbiAgQ29udGVudENoaWxkcmVuLFxyXG4gIFF1ZXJ5TGlzdCxcclxuICBJbmplY3QsIGZvcndhcmRSZWZcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQXJ0Ym9hcmQsIFNNSUlucHV0LCBTdGF0ZU1hY2hpbmUsIFN0YXRlTWFjaGluZUluc3RhbmNlIH0gZnJvbSAnQHJpdmUtYXBwL2NhbnZhcy1hZHZhbmNlZCc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgb2YsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBSaXZlQ2FudmFzIH0gZnJvbSAnLi9jYW52YXMnO1xyXG5pbXBvcnQgeyBSaXZlU2VydmljZSB9IGZyb20gJy4vc2VydmljZSc7XHJcblxyXG4vLy8vLy8vLy8vL1xyXG4vLyBJTlBVVCAvL1xyXG4vLy8vLy8vLy8vL1xyXG5jb25zdCBlbnVtIElucHV0VHlwZXMge1xyXG4gIE51bWJlciA9IDU2LFxyXG4gIFRyaWdnZXIgPSA1OCxcclxuICBCb29sZWFuID0gNTksXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldElucHV0KGlucHV0OiBTTUlJbnB1dCkge1xyXG4gIGlmIChpbnB1dC50eXBlID09PSBJbnB1dFR5cGVzLk51bWJlcikgcmV0dXJuIGlucHV0LmFzTnVtYmVyKCk7XHJcbiAgaWYgKGlucHV0LnR5cGUgPT09IElucHV0VHlwZXMuQm9vbGVhbikgcmV0dXJuIGlucHV0LmFzQm9vbCgpO1xyXG4gIGlmIChpbnB1dC50eXBlID09PSBJbnB1dFR5cGVzLlRyaWdnZXIpIHJldHVybiBpbnB1dC5hc1RyaWdnZXIoKTtcclxuICByZXR1cm4gaW5wdXQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFzc2VydFN0YXRlTWFjaGluZShhbmltYXRpb246IFN0YXRlTWFjaGluZSwgYXJ0Ym9hcmQ6IEFydGJvYXJkLCBuYW1lOiBzdHJpbmcgfCBudW1iZXIpIHtcclxuICBpZiAoYW5pbWF0aW9uKSByZXR1cm47XHJcbiAgY29uc3QgYXJ0Ym9hcmROYW1lID0gYXJ0Ym9hcmQubmFtZSA/PyAnRGVmYXVsdCc7XHJcbiAgY29uc3QgY291bnQgPSBhcnRib2FyZC5zdGF0ZU1hY2hpbmVDb3VudCgpO1xyXG4gIGlmICh0eXBlb2YgbmFtZSA9PT0gJ251bWJlcicpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihgUHJvdmlkZWQgaW5kZXggXCIke25hbWV9XCIgZm9yIHRoZSBhbmltYXRpb24gb2YgYXJ0Ym9hcmQgXCIke2FydGJvYXJkTmFtZX1cIiBpcyBub3QgYXZhaWxhYmxlLiBBbmltYXRpb24gY291bnQgaXM6ICR7Y291bnR9YClcclxuICB9IGVsc2Uge1xyXG4gICAgY29uc3QgbmFtZXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcclxuICAgICAgbmFtZXMucHVzaChhcnRib2FyZC5zdGF0ZU1hY2hpbmVCeUluZGV4KGkpLm5hbWUpO1xyXG4gICAgfVxyXG4gICAgdGhyb3cgbmV3IEVycm9yKGBQcm92aWRlZCBuYW1lIFwiJHtuYW1lfVwiIGZvciB0aGUgYW5pbWF0aW9uIG9mIGFydGJvYXJkIFwiJHthcnRib2FyZE5hbWV9XCIgaXMgbm90IGF2YWlsYWJsZS4gQXZhaWxhYmxlcyBuYW1lcyBhcmU6ICR7SlNPTi5zdHJpbmdpZnkobmFtZXMpfWApO1xyXG4gIH1cclxufVxyXG5cclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAncml2LWlucHV0LCBbcml2SW5wdXRdJyxcclxuICBleHBvcnRBczogJ3JpdklucHV0JyxcclxuICBzdGFuZGFsb25lOiB0cnVlXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBSaXZlU01JbnB1dCB7XHJcbiAgcHJpdmF0ZSBfbmFtZT86IHN0cmluZztcclxuICBwcml2YXRlIF92YWx1ZT86IGJvb2xlYW4gfCBudW1iZXI7XHJcbiAgcHJpdmF0ZSBpbnB1dD86IFNNSUlucHV0O1xyXG4gIHByaXZhdGUgc2hvdWxkRmlyZT86IChpbnB1dDogU01JSW5wdXQpID0+IHZvaWQ7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IG5hbWUobmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XHJcbiAgICBpZiAoIW5hbWUpIHJldHVybjtcclxuICAgIHRoaXMuX25hbWUgPSBuYW1lO1xyXG4gICAgaWYgKHRoaXMuaW5wdXQpIHJldHVybjtcclxuICAgIHRoaXMuaW5pdCh0aGlzLnN0YXRlTWFjaGluZS5pbnB1dHNbbmFtZV0pO1xyXG4gIH1cclxuICBnZXQgbmFtZSgpIHtcclxuICAgIHJldHVybiB0aGlzLmlucHV0Py5uYW1lID8/IHRoaXMuX25hbWU7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCB2YWx1ZShyYXdWYWx1ZTogc3RyaW5nIHwgYm9vbGVhbiB8IG51bWJlciB8IHVuZGVmaW5lZCB8IG51bGwpIHtcclxuICAgIGlmICh0eXBlb2YgcmF3VmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHJhd1ZhbHVlID09PSBudWxsKSByZXR1cm47XHJcbiAgICBjb25zdCB2YWx1ZSA9IHR5cGVvZiByYXdWYWx1ZSA9PT0gJ3N0cmluZydcclxuICAgICAgPyBwYXJzZUZsb2F0KHJhd1ZhbHVlKVxyXG4gICAgICA6IHJhd1ZhbHVlO1xyXG4gICAgaWYgKHRoaXMuaW5wdXQpIHtcclxuICAgICAgdGhpcy5pbnB1dC52YWx1ZSA9IHZhbHVlO1xyXG4gICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMuaW5wdXQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5fdmFsdWUgPSB2YWx1ZTtcclxuICAgIH1cclxuICB9XHJcbiAgZ2V0IHZhbHVlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5wdXQ/LnZhbHVlID8/IHRoaXMuX3ZhbHVlO1xyXG4gIH1cclxuXHJcbiAgQE91dHB1dCgpIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8U01JSW5wdXQ+KCk7XHJcbiAgQE91dHB1dCgpIGxvYWQgPSBuZXcgRXZlbnRFbWl0dGVyPFNNSUlucHV0PigpO1xyXG5cclxuICBjb25zdHJ1Y3RvcihASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gUml2ZVN0YXRlTWFjaGluZSkpIHByaXZhdGUgc3RhdGVNYWNoaW5lOiBSaXZlU3RhdGVNYWNoaW5lKSB7fVxyXG5cclxuICAvKiogQGludGVybmFsOiBVc2VkIGJ5IHRoZSBSaXZlU3RhdGVNYWNoaW5lICovXHJcbiAgcHVibGljIGluaXQoaW5wdXQ/OiBTTUlJbnB1dCkge1xyXG4gICAgaWYgKCFpbnB1dCB8fCBpbnB1dC5uYW1lID09PSB0aGlzLmlucHV0Py5uYW1lKSByZXR1cm47XHJcbiAgICB0aGlzLmlucHV0ID0gZ2V0SW5wdXQoaW5wdXQpO1xyXG4gICAgdGhpcy5sb2FkLmVtaXQoaW5wdXQpO1xyXG4gICAgaWYgKHR5cGVvZiB0aGlzLl92YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgdGhpcy5pbnB1dC52YWx1ZSA9IHRoaXMuX3ZhbHVlO1xyXG4gICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMuaW5wdXQpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuc2hvdWxkRmlyZSkge1xyXG4gICAgICB0aGlzLnNob3VsZEZpcmUoaW5wdXQpO1xyXG4gICAgICBkZWxldGUgdGhpcy5zaG91bGRGaXJlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZmlyZSgpIHtcclxuICAgIGNvbnN0IGZpcmUgPSAoaW5wdXQ6IFNNSUlucHV0KSA9PiB7XHJcbiAgICAgIGlmIChpbnB1dC50eXBlID09PSBJbnB1dFR5cGVzLlRyaWdnZXIpIHtcclxuICAgICAgICBpbnB1dC5maXJlKCk7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2UuZW1pdChpbnB1dCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuaW5wdXRcclxuICAgICAgPyBmaXJlKHRoaXMuaW5wdXQpXHJcbiAgICAgIDogdGhpcy5zaG91bGRGaXJlID0gZmlyZTtcclxuICB9XHJcbn1cclxuXHJcblxyXG4vLy8vLy8vLy8vLy8vLy8vLy8vXHJcbi8vIFNUQVRFIE1BQ0hJTkUgLy9cclxuLy8vLy8vLy8vLy8vLy8vLy8vL1xyXG5cclxuaW50ZXJmYWNlIFN0YXRlTWFjaGluZVN0YXRlIHtcclxuICBzcGVlZDogbnVtYmVyO1xyXG4gIHBsYXlpbmc6IGJvb2xlYW47XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4aXN0PFQ+KHY6IFQgfCB1bmRlZmluZWQgfCBudWxsKTogdiBpcyBUIHtcclxuICByZXR1cm4gdiAhPT0gdW5kZWZpbmVkICYmIHYgIT09IG51bGw7XHJcbn1cclxuXHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAncml2LXN0YXRlLW1hY2hpbmUsIFtyaXZTdGF0ZU1hY2hpbmVdJyxcclxuICAgIGV4cG9ydEFzOiAncml2U3RhdGVNYWNoaW5lJyxcclxuICAgIHN0YW5kYWxvbmU6IHRydWVcclxufSlcclxuZXhwb3J0IGNsYXNzIFJpdmVTdGF0ZU1hY2hpbmUgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgc3ViPzogU3Vic2NyaXB0aW9uO1xyXG4gIC8qKiBAaW50ZXJuYWw6IHB1YmxpYyBvbmx5IGZvciBSaXZlSW5wdXQgKi9cclxuICBwdWJsaWMgaW5zdGFuY2U/OiBTdGF0ZU1hY2hpbmVJbnN0YW5jZTtcclxuICBwdWJsaWMgc3RhdGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFN0YXRlTWFjaGluZVN0YXRlPih7IHNwZWVkOiAxLCBwbGF5aW5nOiBmYWxzZSB9KTtcclxuXHJcbiAgcHVibGljIGlucHV0czogUmVjb3JkPHN0cmluZywgU01JSW5wdXQ+ID0ge307XHJcbiAgQENvbnRlbnRDaGlsZHJlbihSaXZlU01JbnB1dCkgcHJpdmF0ZSByaXZlSW5wdXRzPzogUXVlcnlMaXN0PFJpdmVTTUlucHV0PjtcclxuXHJcbiAgQE91dHB1dCgpIGxvYWQgPSBuZXcgRXZlbnRFbWl0dGVyPFN0YXRlTWFjaGluZUluc3RhbmNlPigpO1xyXG4gIEBPdXRwdXQoKSBzdGF0ZUNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nW10+KCk7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IG5hbWUobmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCkge1xyXG4gICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgcmV0dXJuO1xyXG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgdGhpcy5yZWdpc3RlcihuYW1lKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KClcclxuICBzZXQgaW5kZXgodmFsdWU6IG51bWJlciB8IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwpIHtcclxuICAgIGNvbnN0IGluZGV4ID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlSW50KHZhbHVlKSA6IHZhbHVlO1xyXG4gICAgaWYgKHR5cGVvZiBpbmRleCAhPT0gJ251bWJlcicpIHJldHVybjtcclxuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgIHRoaXMucmVnaXN0ZXIoaW5kZXgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCBzcGVlZCh2YWx1ZTogbnVtYmVyIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCkge1xyXG4gICAgY29uc3Qgc3BlZWQgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VGbG9hdCh2YWx1ZSkgOiB2YWx1ZTtcclxuICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICdudW1iZXInKSB0aGlzLnVwZGF0ZSh7IHNwZWVkIH0pO1xyXG4gIH1cclxuICBnZXQgc3BlZWQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXRWYWx1ZSgpLnNwZWVkO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KCkgc2V0IHBsYXkocGxheWluZzogYm9vbGVhbiB8ICcnIHwgdW5kZWZpbmVkIHwgbnVsbCkge1xyXG4gICAgaWYgKHBsYXlpbmcgPT09IHRydWUgfHwgcGxheWluZyA9PT0gJycpIHtcclxuICAgICAgdGhpcy51cGRhdGUoeyBwbGF5aW5nOiB0cnVlIH0pO1xyXG4gICAgfSBlbHNlIGlmIChwbGF5aW5nID09PSBmYWxzZSkge1xyXG4gICAgICB0aGlzLnVwZGF0ZSh7IHBsYXlpbmc6IGZhbHNlIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBnZXQgcGxheSgpIHtcclxuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldFZhbHVlKCkucGxheWluZztcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXHJcbiAgICBwcml2YXRlIGNhbnZhczogUml2ZUNhbnZhcyxcclxuICAgIHByaXZhdGUgc2VydmljZTogUml2ZVNlcnZpY2UsXHJcbiAgKSB7fVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIGNvbnN0IG5hbWUgPSB0aGlzLmluc3RhbmNlPy5uYW1lO1xyXG4gICAgaWYgKG5hbWUpIGRlbGV0ZSB0aGlzLmNhbnZhcy5zdGF0ZU1hY2hpbmVzW25hbWVdO1xyXG4gICAgdGhpcy5zdWI/LnVuc3Vic2NyaWJlKCk7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuaW5zdGFuY2U/LmRlbGV0ZSgpLCAxMDApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGUoc3RhdGU6IFBhcnRpYWw8U3RhdGVNYWNoaW5lU3RhdGU+KSB7XHJcbiAgICB0aGlzLnN0YXRlLm5leHQoey4uLnRoaXMuc3RhdGUuZ2V0VmFsdWUoKSwgLi4uc3RhdGUgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldElucHV0KGlucHV0OiBTTUlJbnB1dCkge1xyXG4gICAgdGhpcy5pbnB1dHNbaW5wdXQubmFtZV0gPSBpbnB1dDtcclxuICAgIGNvbnN0IHJpdmVJbnB1dCA9IHRoaXMucml2ZUlucHV0cz8uZmluZChpdGVtID0+IGl0ZW0ubmFtZSA9PT0gaW5wdXQubmFtZSk7XHJcbiAgICBpZiAocml2ZUlucHV0KSB7XHJcbiAgICAgIHJpdmVJbnB1dC5pbml0KGlucHV0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RnJhbWUoc3RhdGU6IFN0YXRlTWFjaGluZVN0YXRlKSB7XHJcbiAgICBpZiAoc3RhdGUucGxheWluZyAmJiB0aGlzLnNlcnZpY2UuZnJhbWUpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc2VydmljZS5mcmFtZS5waXBlKG1hcCgodGltZSkgPT4gW3N0YXRlLCB0aW1lXSBhcyBjb25zdCkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG9mKG51bGwpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgcHJpdmF0ZSBpbml0U3RhdGVNYWNoaW5lKG5hbWU6IHN0cmluZyB8IG51bWJlcikge1xyXG4gICAgaWYgKCF0aGlzLmNhbnZhcy5yaXZlKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIHN0YXRlIG1hY2hpbmUgaW5zdGFuY2UgYmVmb3JlIHJpdmUnKTtcclxuICAgIGlmICghdGhpcy5jYW52YXMuYXJ0Ym9hcmQpIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGxvYWQgc3RhdGUgbWFjaGluZSBpbnN0YW5jZSBiZWZvcmUgYXJ0Ym9hcmQnKTtcclxuICAgIGNvbnN0IHJlZiA9IHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJ1xyXG4gICAgICA/IHRoaXMuY2FudmFzLmFydGJvYXJkLnN0YXRlTWFjaGluZUJ5TmFtZShuYW1lKVxyXG4gICAgICA6IHRoaXMuY2FudmFzLmFydGJvYXJkLnN0YXRlTWFjaGluZUJ5SW5kZXgobmFtZSk7XHJcblxyXG4gICAgYXNzZXJ0U3RhdGVNYWNoaW5lKHJlZiwgdGhpcy5jYW52YXMuYXJ0Ym9hcmQsIG5hbWUpO1xyXG5cclxuICAgIC8vIEZldGNoIHRoZSBpbnB1dHMgZnJvbSB0aGUgcnVudGltZSBpZiB3ZSBkb24ndCBoYXZlIHRoZW1cclxuICAgIHRoaXMuaW5zdGFuY2UgPSBuZXcgdGhpcy5jYW52YXMucml2ZS5TdGF0ZU1hY2hpbmVJbnN0YW5jZShyZWYsIHRoaXMuY2FudmFzLmFydGJvYXJkKTtcclxuICAgIHRoaXMuY2FudmFzLnN0YXRlTWFjaGluZXNbdGhpcy5pbnN0YW5jZS5uYW1lXSA9IHRoaXMuaW5zdGFuY2U7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuaW5zdGFuY2UuaW5wdXRDb3VudCgpOyBpKyspIHtcclxuICAgICAgdGhpcy5zZXRJbnB1dCh0aGlzLmluc3RhbmNlLmlucHV0KGkpKTtcclxuICAgIH1cclxuICAgIHRoaXMubG9hZC5lbWl0KHRoaXMuaW5zdGFuY2UpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlcihuYW1lOiBzdHJpbmcgfCBudW1iZXIpIHtcclxuICAgIC8vIFN0b3Agc3Vic2NyaWJpbmcgdG8gcHJldmlvdXMgYW5pbWF0aW9uIGlmIGFueVxyXG4gICAgdGhpcy5zdWI/LnVuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgLy8gVXBkYXRlIG9uIGZyYW1lIGNoYW5nZSBpZiBwbGF5aW5nXHJcbiAgICBjb25zdCBvbkZyYW1lQ2hhbmdlID0gdGhpcy5zdGF0ZS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHN0YXRlKSA9PiB0aGlzLmdldEZyYW1lKHN0YXRlKSksXHJcbiAgICAgIGZpbHRlcihleGlzdCksXHJcbiAgICAgIG1hcCgoW3N0YXRlLCB0aW1lXSkgPT4gKHRpbWUgLyAxMDAwKSAqIHN0YXRlLnNwZWVkKVxyXG4gICAgKTtcclxuXHJcbiAgICAvLyBXYWl0IGZvciBjYW52YXMgJiBhbmltYXRpb24gdG8gYmUgbG9hZGVkXHJcbiAgICB0aGlzLnN1YiA9IHRoaXMuY2FudmFzLm9uUmVhZHkoKS5waXBlKFxyXG4gICAgICBtYXAoKCkgPT4gdGhpcy5pbml0U3RhdGVNYWNoaW5lKG5hbWUpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IG9uRnJhbWVDaGFuZ2UpXHJcbiAgICApLnN1YnNjcmliZSgoZGVsdGEpID0+IHRoaXMuYXBwbHlDaGFuZ2UoZGVsdGEpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXBwbHlDaGFuZ2UoZGVsdGE6IG51bWJlcikge1xyXG4gICAgaWYgKCF0aGlzLmluc3RhbmNlKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIHN0YXRlIG1hY2hpbiBpbnN0YW5jZSBiZWZvcmUgcnVubmluZyBpdCcpO1xyXG4gICAgdGhpcy5jYW52YXMuZHJhdyh0aGlzLmluc3RhbmNlLCBkZWx0YSk7XHJcbiAgICAvLyBDaGVjayBmb3IgYW55IHN0YXRlIG1hY2hpbmVzIHRoYXQgaGFkIGEgc3RhdGUgY2hhbmdlXHJcbiAgICBjb25zdCBjaGFuZ2VDb3VudCA9IHRoaXMuaW5zdGFuY2Uuc3RhdGVDaGFuZ2VkQ291bnQoKTtcclxuICAgIGlmIChjaGFuZ2VDb3VudCkge1xyXG4gICAgICBjb25zdCBzdGF0ZXMgPSBbXTtcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFuZ2VDb3VudDsgaSsrKSB7XHJcbiAgICAgICAgc3RhdGVzLnB1c2godGhpcy5pbnN0YW5jZS5zdGF0ZUNoYW5nZWROYW1lQnlJbmRleChpKSk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zdGF0ZUNoYW5nZS5lbWl0KHN0YXRlcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxufVxyXG5cclxuXHJcbiJdfQ==