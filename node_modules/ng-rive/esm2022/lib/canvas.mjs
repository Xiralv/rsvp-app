import { Directive, ElementRef, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { Observable, BehaviorSubject, from } from 'rxjs';
import { distinctUntilChanged, filter, map, shareReplay, switchMap, tap } from 'rxjs/operators';
import { RiveService } from './service';
import { getClientCoordinates, toInt } from './utils';
import * as i0 from "@angular/core";
import * as i1 from "./service";
const exist = (v) => v !== null && v !== undefined;
const onVisible = (element) => new Promise((res, rej) => {
    // SSR
    if (typeof window === 'undefined') {
        return res(false);
    }
    // Compatibility
    if (!('IntersectionObserver' in window)) {
        return res(true);
    }
    let isVisible = false;
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const visible = entry.intersectionRatio !== 0;
            if (visible !== isVisible) {
                res(isVisible);
                observer.disconnect();
            }
        });
    }, { threshold: [0] });
    // start observing element visibility
    observer.observe(element);
});
// Force event to run inside zones
export function enterZone(zone) {
    return (source) => new Observable(observer => source.subscribe({
        next: (x) => zone.run(() => observer.next(x)),
        error: (err) => observer.error(err),
        complete: () => observer.complete()
    }));
}
export class RiveCanvas {
    set riv(url) {
        this.url.next(url);
    }
    set name(name) {
        this.arboardName.next(name);
    }
    set width(w) {
        const width = toInt(w) ?? this.canvas.width;
        this.canvas.width = width;
    }
    get width() {
        return this.canvas.width;
    }
    set height(h) {
        const height = toInt(h) ?? this.canvas.height;
        this.canvas.height = height;
    }
    get height() {
        return this.canvas.height;
    }
    pointerMove(event) {
        const stateMachines = Object.values(this.stateMachines).filter(sm => 'pointerMove' in sm);
        if (!stateMachines.length)
            return;
        const vector = this.getTransform(event);
        if (!vector)
            return;
        for (const stateMachine of stateMachines) {
            stateMachine.pointerMove(vector.x, vector.y);
        }
    }
    pointerDown(event) {
        const stateMachines = Object.values(this.stateMachines).filter(sm => 'pointerDown' in sm);
        if (!stateMachines.length)
            return;
        const vector = this.getTransform(event);
        if (!vector)
            return;
        for (const stateMachine of stateMachines) {
            stateMachine.pointerDown(vector.x, vector.y);
        }
    }
    pointerUp(event) {
        const stateMachines = Object.values(this.stateMachines).filter(sm => 'pointerUp' in sm);
        if (!stateMachines.length)
            return;
        const vector = this.getTransform(event);
        if (!vector)
            return;
        for (const stateMachine of stateMachines) {
            stateMachine.pointerUp(vector.x, vector.y);
        }
    }
    constructor(service, element) {
        this.service = service;
        this.url = new BehaviorSubject(null);
        this.arboardName = new BehaviorSubject(null);
        this.boxes = {};
        // Keep track of current state machine for event listeners
        this.stateMachines = {};
        this.viewbox = '0 0 100% 100%';
        this.lazy = false;
        this.fit = 'contain';
        this.alignment = 'center';
        this.artboardChange = new EventEmitter();
        this.canvas = element.nativeElement;
        this.whenVisible = onVisible(element.nativeElement);
        this.loaded = this.url.pipe(filter(exist), distinctUntilChanged(), filter(() => typeof window !== 'undefined' && !!this.ctx), // Make sure it's not ssr
        switchMap(async (url) => {
            this.file = await this.service.load(url);
            this.rive = this.service.rive;
            if (!this.rive)
                throw new Error('Service could not load rive');
            // TODO: set offscreen renderer to true for webgl
            this.renderer = this.rive.makeRenderer(this.canvas);
        }), switchMap(_ => this.setArtboard()), shareReplay({ bufferSize: 1, refCount: true }));
    }
    ngOnInit() {
        this.onReady();
    }
    ngOnDestroy() {
        // Timeout to avoid late request to a deleted artboard
        setTimeout(() => {
            this.renderer?.delete();
            this.artboard?.delete();
            this.file?.delete();
        }, 100);
    }
    get ctx() {
        if (!this._ctx) {
            this._ctx = this.canvas.getContext('2d');
        }
        return this._ctx;
    }
    setArtboard() {
        return this.arboardName.pipe(tap(() => this.artboard?.delete()), // Remove previous artboard if any
        map(name => name ? this.file?.artboardByName(name) : this.file?.defaultArtboard()), tap(artboard => this.artboard = artboard), tap(() => this.artboardChange.emit(this.artboard)), map(() => true));
    }
    /**
     * Calculate the box of the canvas based on viewbox, width and height
     * It memorizes the values to avoid recalculation for each frame
     */
    get box() {
        const w = this.width;
        const h = this.height;
        const boxId = `${this.viewbox} ${w} ${h}`;
        if (!this.boxes[boxId]) {
            const bounds = this.viewbox.split(' ');
            if (bounds.length !== 4)
                throw new Error('View box should look like "0 0 100% 100%"');
            const [minX, minY, maxX, maxY] = bounds.map((v, i) => {
                const size = i % 2 === 0 ? w : h;
                const percentage = v.endsWith('%')
                    ? parseInt(v.slice(0, -1), 10) / 100
                    : parseInt(v, 10) / size;
                return i < 2 ? -size * percentage : size / percentage;
            });
            this.boxes[boxId] = { minX, minY, maxX, maxY };
        }
        return this.boxes[boxId];
    }
    get isLazy() {
        return this.lazy === true || this.lazy === '';
    }
    get count() {
        return this.artboard?.animationCount();
    }
    onReady() {
        if (this.isLazy) {
            return from(this.whenVisible).pipe(filter(isVisible => isVisible), switchMap(() => this.loaded));
        }
        return this.loaded;
    }
    draw(instance, delta, mix) {
        if (!this.rive)
            throw new Error('Could not load rive before registrating instance');
        if (!this.artboard)
            throw new Error('Could not load artboard before registrating instance');
        if (!this.renderer)
            throw new Error('Could not load renderer before registrating instance');
        this.renderer.clear();
        // Move frame
        if (isLinearAnimation(instance)) {
            instance.advance(delta);
            instance.apply(mix ?? 1);
        }
        else {
            instance.advance(delta);
        }
        this.artboard.advance(delta);
        // Render frame on canvas
        this.renderer.save();
        // Align renderer if needed
        const fit = this.rive.Fit[this.fit];
        const alignment = this.rive.Alignment[this.alignment];
        const box = this.box;
        const bounds = this.artboard.bounds;
        this.renderer.align(fit, alignment, box, bounds);
        this.artboard.draw(this.renderer);
        this.renderer.restore();
        // TODO: If context is WebGL Flush
        // this.renderer.flush();
    }
    getTransform(event) {
        if (!this.rive)
            return;
        if (!this.artboard)
            return;
        const boundingRect = this.canvas.getBoundingClientRect();
        const { clientX, clientY } = getClientCoordinates(event);
        if (!clientX && !clientY)
            return;
        const canvasX = clientX - boundingRect.left;
        const canvasY = clientY - boundingRect.top;
        const forwardMatrix = this.rive.computeAlignment(this.rive.Fit[this.fit], this.rive.Alignment[this.alignment], {
            minX: 0,
            minY: 0,
            maxX: boundingRect.width,
            maxY: boundingRect.height,
        }, this.artboard.bounds);
        const invertedMatrix = new this.rive.Mat2D();
        forwardMatrix.invert(invertedMatrix);
        const canvasCoordinatesVector = new this.rive.Vec2D(canvasX, canvasY);
        const transformedVector = this.rive.mapXY(invertedMatrix, canvasCoordinatesVector);
        const x = transformedVector.x();
        const y = transformedVector.y();
        transformedVector.delete();
        invertedMatrix.delete();
        canvasCoordinatesVector.delete();
        forwardMatrix.delete();
        return { x, y };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RiveCanvas, deps: [{ token: i1.RiveService }, { token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.1.4", type: RiveCanvas, isStandalone: true, selector: "canvas[riv]", inputs: { riv: "riv", name: ["artboard", "name"], viewbox: "viewbox", lazy: "lazy", fit: "fit", alignment: "alignment", width: "width", height: "height" }, outputs: { artboardChange: "artboardChange" }, host: { listeners: { "touchmove": "pointerMove($event)", "mouseover": "pointerMove($event)", "mouseout": "pointerMove($event)", "mousemove": "pointerMove($event)", "touchstart": "pointerDown($event)", "mousedown": "pointerDown($event)", "touchend": "pointerUp($event)", "mouseup": "pointerUp($event)" } }, exportAs: ["rivCanvas"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RiveCanvas, decorators: [{
            type: Directive,
            args: [{
                    selector: 'canvas[riv]',
                    exportAs: 'rivCanvas',
                    standalone: true
                }]
        }], ctorParameters: function () { return [{ type: i1.RiveService }, { type: i0.ElementRef }]; }, propDecorators: { riv: [{
                type: Input
            }], name: [{
                type: Input,
                args: ['artboard']
            }], viewbox: [{
                type: Input
            }], lazy: [{
                type: Input
            }], fit: [{
                type: Input
            }], alignment: [{
                type: Input
            }], width: [{
                type: Input
            }], height: [{
                type: Input
            }], artboardChange: [{
                type: Output
            }], pointerMove: [{
                type: HostListener,
                args: ['touchmove', ['$event']]
            }, {
                type: HostListener,
                args: ['mouseover', ['$event']]
            }, {
                type: HostListener,
                args: ['mouseout', ['$event']]
            }, {
                type: HostListener,
                args: ['mousemove', ['$event']]
            }], pointerDown: [{
                type: HostListener,
                args: ['touchstart', ['$event']]
            }, {
                type: HostListener,
                args: ['mousedown', ['$event']]
            }], pointerUp: [{
                type: HostListener,
                args: ['touchend', ['$event']]
            }, {
                type: HostListener,
                args: ['mouseup', ['$event']]
            }] } });
function isLinearAnimation(instance) {
    return 'didLoop' in instance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZy1yaXZlL3NyYy9saWIvY2FudmFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUE2QixNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEcsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV4QyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7QUFPdEQsTUFBTSxLQUFLLEdBQUcsQ0FBSSxDQUFZLEVBQVUsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLFNBQVMsQ0FBQztBQUV6RSxNQUFNLFNBQVMsR0FBRyxDQUFDLE9BQW9CLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQzVFLE1BQU07SUFDTixJQUFJLE9BQU8sTUFBTSxLQUFLLFdBQVcsRUFBRTtRQUNqQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUNuQjtJQUNELGdCQUFnQjtJQUNoQixJQUFJLENBQUMsQ0FBQyxzQkFBc0IsSUFBSSxNQUFNLENBQUMsRUFBRTtRQUN2QyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNsQjtJQUNELElBQUksU0FBUyxHQUFHLEtBQUssQ0FBQztJQUN0QixNQUFNLFFBQVEsR0FBRyxJQUFJLG9C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QUFXO3NCQUZsQixZQUFZO3VCQUFDLFlBQVksRUFBRSxDQUFDLFFBQVEsQ0FBQzs7c0JBQ3JDLFlBQVk7dUJBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDO2dCQWE3QixTQUFTO3NCQUZoQixZQUFZO3VCQUFDLFVBQVUsRUFBRSxDQUFDLFFBQVEsQ0FBQzs7c0JBQ25DLFlBQVk7dUJBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDOztBQXNMckMsU0FBUyxpQkFBaUIsQ0FBQyxRQUF3RDtJQUNqRixPQUFPLFNBQVMsSUFBSSxRQUFRLENBQUM7QUFDL0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIElucHV0LCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCBmcm9tIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBSaXZlU2VydmljZSB9IGZyb20gJy4vc2VydmljZSc7XHJcbmltcG9ydCB7IEFydGJvYXJkLCBDYW52YXNSZW5kZXJlciwgUml2ZUNhbnZhcyBhcyBSaXZlLCBGaWxlIGFzIFJpdmVGaWxlLCBBQUJCLCBTdGF0ZU1hY2hpbmVJbnN0YW5jZSwgTGluZWFyQW5pbWF0aW9uSW5zdGFuY2UgfSBmcm9tICdAcml2ZS1hcHAvY2FudmFzLWFkdmFuY2VkJztcclxuaW1wb3J0IHsgZ2V0Q2xpZW50Q29vcmRpbmF0ZXMsIHRvSW50IH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5leHBvcnQgdHlwZSBDYW52YXNGaXQgPSAnY292ZXInIHwgJ2NvbnRhaW4nIHwgJ2ZpbGwnIHwgJ2ZpdFdpZHRoJyB8ICdmaXRIZWlnaHQnIHwgJ25vbmUnIHwgJ3NjYWxlRG93bic7XHJcbmV4cG9ydCB0eXBlIENhbnZhc0FsaWdubWVudCA9ICdjZW50ZXInIHwgJ3RvcExlZnQnIHwgJ3RvcENlbnRlcicgfCAndG9wUmlnaHQnIHwgJ2NlbnRlckxlZnQnIHwgJ2NlbnRlclJpZ2h0JyB8ICdib3R0b21MZWZ0JyB8ICdib3R0b21DZW50ZXInIHwgJ2JvdHRvbVJpZ2h0JztcclxuXHJcbmV4cG9ydCB0eXBlIFJpdmVPcmlnaW4gPSBzdHJpbmcgfCBGaWxlIHwgQmxvYiB8IG51bGw7XHJcblxyXG5jb25zdCBleGlzdCA9IDxUPih2PzogVCB8IG51bGwpOiB2IGlzIFQgPT4gdiAhPT0gbnVsbCAmJiB2ICE9PSB1bmRlZmluZWQ7XHJcblxyXG5jb25zdCBvblZpc2libGUgPSAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXMsIHJlaikgPT4ge1xyXG4gIC8vIFNTUlxyXG4gIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgcmV0dXJuIHJlcyhmYWxzZSk7XHJcbiAgfVxyXG4gIC8vIENvbXBhdGliaWxpdHlcclxuICBpZiAoISgnSW50ZXJzZWN0aW9uT2JzZXJ2ZXInIGluIHdpbmRvdykpIHtcclxuICAgIHJldHVybiByZXModHJ1ZSk7XHJcbiAgfVxyXG4gIGxldCBpc1Zpc2libGUgPSBmYWxzZTtcclxuICBjb25zdCBvYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcigoZW50cmllcykgPT4ge1xyXG4gICAgZW50cmllcy5mb3JFYWNoKGVudHJ5ID0+IHtcclxuICAgICAgY29uc3QgdmlzaWJsZSA9IGVudHJ5LmludGVyc2VjdGlvblJhdGlvICE9PSAwO1xyXG4gICAgICBpZiAodmlzaWJsZSAhPT0gaXNWaXNpYmxlKSB7XHJcbiAgICAgICAgcmVzKGlzVmlzaWJsZSk7XHJcbiAgICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9LCB7IHRocmVzaG9sZDogWzBdIH0pO1xyXG4gIC8vIHN0YXJ0IG9ic2VydmluZyBlbGVtZW50IHZpc2liaWxpdHlcclxuICBvYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQpO1xyXG59KTtcclxuXHJcblxyXG4vLyBGb3JjZSBldmVudCB0byBydW4gaW5zaWRlIHpvbmVzXHJcbmV4cG9ydCBmdW5jdGlvbiBlbnRlclpvbmUoem9uZTogTmdab25lKSB7XHJcbiAgcmV0dXJuIDxUPihzb3VyY2U6IE9ic2VydmFibGU8VD4pID0+XHJcbiAgICBuZXcgT2JzZXJ2YWJsZTxUPihvYnNlcnZlciA9PlxyXG4gICAgICBzb3VyY2Uuc3Vic2NyaWJlKHtcclxuICAgICAgICBuZXh0OiAoeCkgPT4gem9uZS5ydW4oKCkgPT4gb2JzZXJ2ZXIubmV4dCh4KSksXHJcbiAgICAgICAgZXJyb3I6IChlcnIpID0+IG9ic2VydmVyLmVycm9yKGVyciksXHJcbiAgICAgICAgY29tcGxldGU6ICgpID0+IG9ic2VydmVyLmNvbXBsZXRlKClcclxuICAgIH0pXHJcbiAgICk7XHJcbn1cclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdjYW52YXNbcml2XScsXHJcbiAgICBleHBvcnRBczogJ3JpdkNhbnZhcycsXHJcbiAgICBzdGFuZGFsb25lOiB0cnVlXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBSaXZlQ2FudmFzIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgdXJsID0gbmV3IEJlaGF2aW9yU3ViamVjdDxSaXZlT3JpZ2luPihudWxsKTtcclxuICBwcml2YXRlIGFyYm9hcmROYW1lID0gbmV3IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPihudWxsKTtcclxuICBwcml2YXRlIF9jdHg/OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsO1xyXG4gIHByaXZhdGUgbG9hZGVkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xyXG4gIHByaXZhdGUgYm94ZXM6IFJlY29yZDxzdHJpbmcsIEFBQkI+ID0ge307XHJcbiAgcHVibGljIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XHJcbiAgcHVibGljIHJpdmU/OiBSaXZlO1xyXG4gIHB1YmxpYyBmaWxlPzogUml2ZUZpbGU7XHJcbiAgcHVibGljIGFydGJvYXJkPzogQXJ0Ym9hcmQ7XHJcbiAgcHVibGljIHJlbmRlcmVyPzogQ2FudmFzUmVuZGVyZXI7XHJcbiAgLy8gS2VlcCB0cmFjayBvZiBjdXJyZW50IHN0YXRlIG1hY2hpbmUgZm9yIGV2ZW50IGxpc3RlbmVyc1xyXG4gIHB1YmxpYyBzdGF0ZU1hY2hpbmVzOiBSZWNvcmQ8c3RyaW5nLCBTdGF0ZU1hY2hpbmVJbnN0YW5jZT4gPSB7fTtcclxuXHJcbiAgcHVibGljIHdoZW5WaXNpYmxlOiBQcm9taXNlPGJvb2xlYW4+O1xyXG5cclxuICBASW5wdXQoKSBzZXQgcml2KHVybDogUml2ZU9yaWdpbikge1xyXG4gICAgdGhpcy51cmwubmV4dCh1cmwpO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KCdhcnRib2FyZCcpIHNldCBuYW1lKG5hbWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5hcmJvYXJkTmFtZS5uZXh0KG5hbWUpO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KCkgdmlld2JveCA9ICcwIDAgMTAwJSAxMDAlJztcclxuICBASW5wdXQoKSBsYXp5OiBib29sZWFuIHwgJycgPSBmYWxzZTtcclxuICBASW5wdXQoKSBmaXQ6IENhbnZhc0ZpdCA9ICdjb250YWluJztcclxuICBASW5wdXQoKSBhbGlnbm1lbnQ6IENhbnZhc0FsaWdubWVudCA9ICdjZW50ZXInO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCB3aWR0aCh3OiBudW1iZXIgfCBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHdpZHRoID0gdG9JbnQodykgPz8gdGhpcy5jYW52YXMud2lkdGg7XHJcbiAgICB0aGlzLmNhbnZhcy53aWR0aCA9IHdpZHRoO1xyXG4gIH1cclxuICBnZXQgd2lkdGgoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jYW52YXMud2lkdGg7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoKVxyXG4gIHNldCBoZWlnaHQoaDogbnVtYmVyIHwgc3RyaW5nKSB7XHJcbiAgICBjb25zdCBoZWlnaHQgPSB0b0ludChoKSA/PyB0aGlzLmNhbnZhcy5oZWlnaHQ7XHJcbiAgICB0aGlzLmNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XHJcbiAgfVxyXG4gIGdldCBoZWlnaHQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jYW52YXMuaGVpZ2h0O1xyXG4gIH1cclxuXHJcbiAgQE91dHB1dCgpIGFydGJvYXJkQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxBcnRib2FyZD4oKTtcclxuXHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ3RvdWNobW92ZScsIFsnJGV2ZW50J10pXHJcbiAgQEhvc3RMaXN0ZW5lcignbW91c2VvdmVyJywgWyckZXZlbnQnXSlcclxuICBASG9zdExpc3RlbmVyKCdtb3VzZW91dCcsIFsnJGV2ZW50J10pXHJcbiAgQEhvc3RMaXN0ZW5lcignbW91c2Vtb3ZlJywgWyckZXZlbnQnXSlcclxuICBwcml2YXRlIHBvaW50ZXJNb3ZlKGV2ZW50OiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCkge1xyXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lcyA9IE9iamVjdC52YWx1ZXModGhpcy5zdGF0ZU1hY2hpbmVzKS5maWx0ZXIoc20gPT4gJ3BvaW50ZXJNb3ZlJyBpbiBzbSk7XHJcbiAgICBpZiAoIXN0YXRlTWFjaGluZXMubGVuZ3RoKSByZXR1cm47XHJcbiAgICBjb25zdCB2ZWN0b3IgPSB0aGlzLmdldFRyYW5zZm9ybShldmVudCk7XHJcbiAgICBpZiAoIXZlY3RvcikgcmV0dXJuO1xyXG4gICAgZm9yIChjb25zdCBzdGF0ZU1hY2hpbmUgb2Ygc3RhdGVNYWNoaW5lcykge1xyXG4gICAgICBzdGF0ZU1hY2hpbmUucG9pbnRlck1vdmUodmVjdG9yLngsIHZlY3Rvci55KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBbJyRldmVudCddKVxyXG4gIEBIb3N0TGlzdGVuZXIoJ21vdXNlZG93bicsIFsnJGV2ZW50J10pXHJcbiAgcHJpdmF0ZSBwb2ludGVyRG93bihldmVudDogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpIHtcclxuICAgIGNvbnN0IHN0YXRlTWFjaGluZXMgPSBPYmplY3QudmFsdWVzKHRoaXMuc3RhdGVNYWNoaW5lcykuZmlsdGVyKHNtID0+ICdwb2ludGVyRG93bicgaW4gc20pO1xyXG4gICAgaWYgKCFzdGF0ZU1hY2hpbmVzLmxlbmd0aCkgcmV0dXJuO1xyXG4gICAgY29uc3QgdmVjdG9yID0gdGhpcy5nZXRUcmFuc2Zvcm0oZXZlbnQpO1xyXG4gICAgaWYgKCF2ZWN0b3IpIHJldHVybjtcclxuICAgIGZvciAoY29uc3Qgc3RhdGVNYWNoaW5lIG9mIHN0YXRlTWFjaGluZXMpIHtcclxuICAgICAgc3RhdGVNYWNoaW5lLnBvaW50ZXJEb3duKHZlY3Rvci54LCB2ZWN0b3IueSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCd0b3VjaGVuZCcsIFsnJGV2ZW50J10pXHJcbiAgQEhvc3RMaXN0ZW5lcignbW91c2V1cCcsIFsnJGV2ZW50J10pXHJcbiAgcHJpdmF0ZSBwb2ludGVyVXAoZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KXtcclxuICAgIGNvbnN0IHN0YXRlTWFjaGluZXMgPSBPYmplY3QudmFsdWVzKHRoaXMuc3RhdGVNYWNoaW5lcykuZmlsdGVyKHNtID0+ICdwb2ludGVyVXAnIGluIHNtKTtcclxuICAgIGlmICghc3RhdGVNYWNoaW5lcy5sZW5ndGgpIHJldHVybjtcclxuICAgIGNvbnN0IHZlY3RvciA9IHRoaXMuZ2V0VHJhbnNmb3JtKGV2ZW50KTtcclxuICAgIGlmICghdmVjdG9yKSByZXR1cm47XHJcbiAgICBmb3IgKGNvbnN0IHN0YXRlTWFjaGluZSBvZiBzdGF0ZU1hY2hpbmVzKSB7XHJcbiAgICAgIHN0YXRlTWFjaGluZS5wb2ludGVyVXAodmVjdG9yLngsIHZlY3Rvci55KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBzZXJ2aWNlOiBSaXZlU2VydmljZSxcclxuICAgIGVsZW1lbnQ6IEVsZW1lbnRSZWY8SFRNTENhbnZhc0VsZW1lbnQ+XHJcbiAgKSB7XHJcbiAgICB0aGlzLmNhbnZhcyA9IGVsZW1lbnQubmF0aXZlRWxlbWVudDtcclxuXHJcbiAgICB0aGlzLndoZW5WaXNpYmxlID0gb25WaXNpYmxlKGVsZW1lbnQubmF0aXZlRWxlbWVudCk7XHJcblxyXG4gICAgdGhpcy5sb2FkZWQgPSB0aGlzLnVybC5waXBlKFxyXG4gICAgICBmaWx0ZXIoZXhpc3QpLFxyXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxyXG4gICAgICBmaWx0ZXIoKCkgPT4gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF0aGlzLmN0eCksICAvLyBNYWtlIHN1cmUgaXQncyBub3Qgc3NyXHJcbiAgICAgIHN3aXRjaE1hcChhc3luYyAodXJsKSA9PiB7XHJcbiAgICAgICAgdGhpcy5maWxlID0gYXdhaXQgdGhpcy5zZXJ2aWNlLmxvYWQodXJsKTtcclxuICAgICAgICB0aGlzLnJpdmUgPSB0aGlzLnNlcnZpY2Uucml2ZTtcclxuICAgICAgICBpZiAoIXRoaXMucml2ZSkgdGhyb3cgbmV3IEVycm9yKCdTZXJ2aWNlIGNvdWxkIG5vdCBsb2FkIHJpdmUnKTtcclxuICAgICAgICAvLyBUT0RPOiBzZXQgb2Zmc2NyZWVuIHJlbmRlcmVyIHRvIHRydWUgZm9yIHdlYmdsXHJcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IHRoaXMucml2ZS5tYWtlUmVuZGVyZXIodGhpcy5jYW52YXMpIGFzIENhbnZhc1JlbmRlcmVyO1xyXG4gICAgICB9KSxcclxuICAgICAgc3dpdGNoTWFwKF8gPT4gdGhpcy5zZXRBcnRib2FyZCgpKSxcclxuICAgICAgc2hhcmVSZXBsYXkoeyBidWZmZXJTaXplOiAxLCByZWZDb3VudDogdHJ1ZSB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMub25SZWFkeSgpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAvLyBUaW1lb3V0IHRvIGF2b2lkIGxhdGUgcmVxdWVzdCB0byBhIGRlbGV0ZWQgYXJ0Ym9hcmRcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyPy5kZWxldGUoKTtcclxuICAgICAgdGhpcy5hcnRib2FyZD8uZGVsZXRlKCk7XHJcbiAgICAgIHRoaXMuZmlsZT8uZGVsZXRlKCk7XHJcbiAgICB9LCAxMDApO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGN0eCgpOiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQge1xyXG4gICAgaWYgKCF0aGlzLl9jdHgpIHtcclxuICAgICAgdGhpcy5fY3R4ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9jdHggYXMgQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRBcnRib2FyZCgpIHtcclxuICAgIHJldHVybiB0aGlzLmFyYm9hcmROYW1lLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmFydGJvYXJkPy5kZWxldGUoKSksIC8vIFJlbW92ZSBwcmV2aW91cyBhcnRib2FyZCBpZiBhbnlcclxuICAgICAgbWFwKG5hbWUgPT4gbmFtZSA/IHRoaXMuZmlsZT8uYXJ0Ym9hcmRCeU5hbWUobmFtZSkgOiB0aGlzLmZpbGU/LmRlZmF1bHRBcnRib2FyZCgpKSxcclxuICAgICAgdGFwKGFydGJvYXJkID0+IHRoaXMuYXJ0Ym9hcmQgPSBhcnRib2FyZCksXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmFydGJvYXJkQ2hhbmdlLmVtaXQodGhpcy5hcnRib2FyZCkpLFxyXG4gICAgICBtYXAoKCkgPT4gdHJ1ZSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDYWxjdWxhdGUgdGhlIGJveCBvZiB0aGUgY2FudmFzIGJhc2VkIG9uIHZpZXdib3gsIHdpZHRoIGFuZCBoZWlnaHRcclxuICAgKiBJdCBtZW1vcml6ZXMgdGhlIHZhbHVlcyB0byBhdm9pZCByZWNhbGN1bGF0aW9uIGZvciBlYWNoIGZyYW1lXHJcbiAgICovXHJcbiAgZ2V0IGJveCgpIHtcclxuICAgIGNvbnN0IHcgPSB0aGlzLndpZHRoIGFzIG51bWJlcjtcclxuICAgIGNvbnN0IGggPSB0aGlzLmhlaWdodCBhcyBudW1iZXI7XHJcbiAgICBjb25zdCBib3hJZCA9IGAke3RoaXMudmlld2JveH0gJHt3fSAke2h9YDtcclxuICAgIGlmICghdGhpcy5ib3hlc1tib3hJZF0pIHtcclxuICAgICAgY29uc3QgYm91bmRzID0gdGhpcy52aWV3Ym94LnNwbGl0KCcgJyk7XHJcbiAgICAgIGlmIChib3VuZHMubGVuZ3RoICE9PSA0KSB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgYm94IHNob3VsZCBsb29rIGxpa2UgXCIwIDAgMTAwJSAxMDAlXCInKTtcclxuICAgICAgY29uc3QgW21pblgsIG1pblksIG1heFgsIG1heFldID0gYm91bmRzLm1hcCgodiwgaSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNpemU6IG51bWJlciA9IGkgJSAyID09PSAwID8gdyA6IGg7XHJcbiAgICAgICAgY29uc3QgcGVyY2VudGFnZSA9IHYuZW5kc1dpdGgoJyUnKVxyXG4gICAgICAgICAgPyBwYXJzZUludCh2LnNsaWNlKDAsIC0xKSwgMTApIC8gMTAwXHJcbiAgICAgICAgICA6IHBhcnNlSW50KHYsIDEwKSAvIHNpemU7XHJcbiAgICAgICAgcmV0dXJuIGkgPCAyID8gLXNpemUgKiBwZXJjZW50YWdlIDogc2l6ZSAvIHBlcmNlbnRhZ2U7XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLmJveGVzW2JveElkXSA9IHttaW5YLCBtaW5ZLCBtYXhYLCBtYXhZfTtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLmJveGVzW2JveElkXTtcclxuICB9XHJcblxyXG4gIGdldCBpc0xhenkoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5sYXp5ID09PSB0cnVlIHx8IHRoaXMubGF6eSA9PT0gJyc7XHJcbiAgfVxyXG5cclxuICBnZXQgY291bnQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5hcnRib2FyZD8uYW5pbWF0aW9uQ291bnQoKTtcclxuICB9XHJcblxyXG4gIG9uUmVhZHkoKSB7XHJcbiAgICBpZiAodGhpcy5pc0xhenkpIHtcclxuICAgICAgcmV0dXJuIGZyb20odGhpcy53aGVuVmlzaWJsZSkucGlwZShcclxuICAgICAgICBmaWx0ZXIoaXNWaXNpYmxlID0+IGlzVmlzaWJsZSksXHJcbiAgICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMubG9hZGVkKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMubG9hZGVkO1xyXG4gIH1cclxuXHJcbiAgZHJhdyhpbnN0YW5jZTogTGluZWFyQW5pbWF0aW9uSW5zdGFuY2UsIGRlbHRhOiBudW1iZXIsIG1peDogbnVtYmVyKTogdm9pZFxyXG4gIGRyYXcoaW5zdGFuY2U6IFN0YXRlTWFjaGluZUluc3RhbmNlLCBkZWx0YTogbnVtYmVyKTogdm9pZFxyXG4gIGRyYXcoaW5zdGFuY2U6IFN0YXRlTWFjaGluZUluc3RhbmNlIHwgTGluZWFyQW5pbWF0aW9uSW5zdGFuY2UsIGRlbHRhOiBudW1iZXIsIG1peD86IG51bWJlcikge1xyXG4gICAgaWYgKCF0aGlzLnJpdmUpIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGxvYWQgcml2ZSBiZWZvcmUgcmVnaXN0cmF0aW5nIGluc3RhbmNlJyk7XHJcbiAgICBpZiAoIXRoaXMuYXJ0Ym9hcmQpIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGxvYWQgYXJ0Ym9hcmQgYmVmb3JlIHJlZ2lzdHJhdGluZyBpbnN0YW5jZScpO1xyXG4gICAgaWYgKCF0aGlzLnJlbmRlcmVyKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIHJlbmRlcmVyIGJlZm9yZSByZWdpc3RyYXRpbmcgaW5zdGFuY2UnKTtcclxuXHJcbiAgICB0aGlzLnJlbmRlcmVyLmNsZWFyKCk7XHJcblxyXG4gICAgLy8gTW92ZSBmcmFtZVxyXG4gICAgaWYgKGlzTGluZWFyQW5pbWF0aW9uKGluc3RhbmNlKSkge1xyXG4gICAgICBpbnN0YW5jZS5hZHZhbmNlKGRlbHRhKTtcclxuICAgICAgaW5zdGFuY2UuYXBwbHkobWl4ID8/IDEpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5zdGFuY2UuYWR2YW5jZShkZWx0YSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmFydGJvYXJkLmFkdmFuY2UoZGVsdGEpO1xyXG5cclxuICAgIC8vIFJlbmRlciBmcmFtZSBvbiBjYW52YXNcclxuICAgIHRoaXMucmVuZGVyZXIuc2F2ZSgpO1xyXG5cclxuICAgIC8vIEFsaWduIHJlbmRlcmVyIGlmIG5lZWRlZFxyXG4gICAgY29uc3QgZml0ID0gdGhpcy5yaXZlLkZpdFt0aGlzLmZpdF07XHJcbiAgICBjb25zdCBhbGlnbm1lbnQgPSB0aGlzLnJpdmUuQWxpZ25tZW50W3RoaXMuYWxpZ25tZW50XTtcclxuICAgIGNvbnN0IGJveCA9IHRoaXMuYm94O1xyXG4gICAgY29uc3QgYm91bmRzID0gdGhpcy5hcnRib2FyZC5ib3VuZHM7XHJcbiAgICB0aGlzLnJlbmRlcmVyLmFsaWduKGZpdCwgYWxpZ25tZW50LCBib3gsIGJvdW5kcyk7XHJcblxyXG4gICAgdGhpcy5hcnRib2FyZC5kcmF3KHRoaXMucmVuZGVyZXIpO1xyXG5cclxuICAgIHRoaXMucmVuZGVyZXIucmVzdG9yZSgpO1xyXG5cclxuICAgIC8vIFRPRE86IElmIGNvbnRleHQgaXMgV2ViR0wgRmx1c2hcclxuICAgIC8vIHRoaXMucmVuZGVyZXIuZmx1c2goKTtcclxuICB9XHJcblxyXG5cclxuICBwcml2YXRlIGdldFRyYW5zZm9ybShldmVudDogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpIHtcclxuICAgIGlmICghdGhpcy5yaXZlKSByZXR1cm47XHJcbiAgICBpZiAoIXRoaXMuYXJ0Ym9hcmQpIHJldHVybjtcclxuICAgIGNvbnN0IGJvdW5kaW5nUmVjdCA9IHRoaXMuY2FudmFzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG5cclxuICAgIGNvbnN0IHsgY2xpZW50WCwgY2xpZW50WSB9ID0gZ2V0Q2xpZW50Q29vcmRpbmF0ZXMoZXZlbnQpO1xyXG4gICAgaWYgKCFjbGllbnRYICYmICFjbGllbnRZKSByZXR1cm47XHJcbiAgICBjb25zdCBjYW52YXNYID0gY2xpZW50WCAtIGJvdW5kaW5nUmVjdC5sZWZ0O1xyXG4gICAgY29uc3QgY2FudmFzWSA9IGNsaWVudFkgLSBib3VuZGluZ1JlY3QudG9wO1xyXG4gICAgY29uc3QgZm9yd2FyZE1hdHJpeCA9IHRoaXMucml2ZS5jb21wdXRlQWxpZ25tZW50KFxyXG4gICAgICB0aGlzLnJpdmUuRml0W3RoaXMuZml0XSxcclxuICAgICAgdGhpcy5yaXZlLkFsaWdubWVudFt0aGlzLmFsaWdubWVudF0sXHJcbiAgICAgIHtcclxuICAgICAgICBtaW5YOiAwLFxyXG4gICAgICAgIG1pblk6IDAsXHJcbiAgICAgICAgbWF4WDogYm91bmRpbmdSZWN0LndpZHRoLFxyXG4gICAgICAgIG1heFk6IGJvdW5kaW5nUmVjdC5oZWlnaHQsXHJcbiAgICAgIH0sXHJcbiAgICAgIHRoaXMuYXJ0Ym9hcmQuYm91bmRzXHJcbiAgICApO1xyXG4gICAgY29uc3QgaW52ZXJ0ZWRNYXRyaXggPSBuZXcgdGhpcy5yaXZlLk1hdDJEKCk7XHJcbiAgICBmb3J3YXJkTWF0cml4LmludmVydChpbnZlcnRlZE1hdHJpeCk7XHJcbiAgICBjb25zdCBjYW52YXNDb29yZGluYXRlc1ZlY3RvciA9IG5ldyB0aGlzLnJpdmUuVmVjMkQoY2FudmFzWCwgY2FudmFzWSk7XHJcbiAgICBjb25zdCB0cmFuc2Zvcm1lZFZlY3RvciA9IHRoaXMucml2ZS5tYXBYWShcclxuICAgICAgaW52ZXJ0ZWRNYXRyaXgsXHJcbiAgICAgIGNhbnZhc0Nvb3JkaW5hdGVzVmVjdG9yXHJcbiAgICApO1xyXG4gICAgY29uc3QgeCA9IHRyYW5zZm9ybWVkVmVjdG9yLngoKTtcclxuICAgIGNvbnN0IHkgPSB0cmFuc2Zvcm1lZFZlY3Rvci55KCk7XHJcblxyXG4gICAgdHJhbnNmb3JtZWRWZWN0b3IuZGVsZXRlKCk7XHJcbiAgICBpbnZlcnRlZE1hdHJpeC5kZWxldGUoKTtcclxuICAgIGNhbnZhc0Nvb3JkaW5hdGVzVmVjdG9yLmRlbGV0ZSgpO1xyXG4gICAgZm9yd2FyZE1hdHJpeC5kZWxldGUoKTtcclxuICAgIHJldHVybiB7eCwgeX07XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpc0xpbmVhckFuaW1hdGlvbihpbnN0YW5jZTogU3RhdGVNYWNoaW5lSW5zdGFuY2UgfCBMaW5lYXJBbmltYXRpb25JbnN0YW5jZSk6IGluc3RhbmNlIGlzIExpbmVhckFuaW1hdGlvbkluc3RhbmNlIHtcclxuICByZXR1cm4gJ2RpZExvb3AnIGluIGluc3RhbmNlO1xyXG59Il19