import { Directive, EventEmitter, Input, NgZone, Output } from "@angular/core";
import { BehaviorSubject, merge, of } from "rxjs";
import { distinctUntilChanged, filter, map, switchMap, tap } from "rxjs/operators";
import { RiveCanvas } from './canvas';
import { RiveService } from "./service";
import * as i0 from "@angular/core";
import * as i1 from "./canvas";
import * as i2 from "./service";
function getRivePlayerState(state = {}) {
    return {
        speed: 1,
        playing: false,
        mix: 1,
        autoreset: false,
        ...state
    };
}
export function frameToSec(frame, fps) {
    return frame / fps;
}
export function round(value) {
    return Math.round((value + Number.EPSILON) * 10000) / 10000;
}
function exist(v) {
    return v !== undefined && v !== null;
}
function getStart(animation) {
    if (!animation.workStart || animation.workStart === -1)
        return 0;
    return round(animation.workStart / animation.fps);
}
function getEnd(animation) {
    const end = (!animation.workEnd || animation.workEnd === -1) ? animation.duration : animation.workEnd;
    return round(end / animation.fps);
}
export class RivePlayer {
    /**
     * Name of the rive animation in the current Artboard
     * Either use name or index to select an animation
     */
    set name(name) {
        if (typeof name !== 'string')
            return;
        this.zone.runOutsideAngular(() => {
            this.register(name);
        });
    }
    /**
     * Index of the rive animation in the current Artboard
     * Either use index of name to select an animation
     */
    set index(value) {
        const index = typeof value === 'string' ? parseInt(value) : value;
        if (typeof index !== 'number')
            return;
        this.zone.runOutsideAngular(() => {
            this.register(index);
        });
    }
    /** The mix of this animation in the current arboard */
    set mix(value) {
        const mix = typeof value === 'string' ? parseFloat(value) : value;
        if (mix && mix >= 0 && mix <= 1)
            this.update({ mix });
    }
    get mix() {
        return this.state.getValue().mix;
    }
    /** Multiplicator of the speed for the animation */
    set speed(value) {
        const speed = typeof value === 'string' ? parseFloat(value) : value;
        if (typeof speed === 'number')
            this.update({ speed });
    }
    get speed() {
        return this.state.getValue().speed;
    }
    set play(playing) {
        if (playing === true || playing === '') {
            this.update({ playing: true });
        }
        else if (playing === false) {
            this.update({ playing: false });
        }
    }
    get play() {
        return this.state.getValue().playing;
    }
    set time(value) {
        const time = typeof value === 'string' ? parseFloat(value) : value;
        if (typeof time === 'number')
            this.distance.next(time);
    }
    /**
     * @deprecated This will be removed
     * Consider using StateMachine instead
     */
    set autoreset(autoreset) {
        if (autoreset === true || autoreset === '') {
            this.update({ autoreset: true });
        }
        else if (autoreset === false) {
            this.update({ autoreset: false });
        }
    }
    get autoreset() {
        return this.state.getValue().autoreset;
    }
    /**
     * @deprecated This will be removed
     * Consider using StateMachine instead
     */
    set mode(mode) {
        if (mode)
            this.update({ mode });
    }
    get mode() {
        return this.state.getValue().mode;
    }
    constructor(zone, canvas, service) {
        this.zone = zone;
        this.canvas = canvas;
        this.service = service;
        this.distance = new BehaviorSubject(null);
        this.state = new BehaviorSubject(getRivePlayerState());
        // eslint-disable-next-line @angular-eslint/no-output-native
        this.load = new EventEmitter();
        this.timeChange = new EventEmitter();
        this.playChange = new EventEmitter();
        this.speedChange = new EventEmitter();
    }
    ngOnDestroy() {
        this.sub?.unsubscribe();
        setTimeout(() => this.instance?.delete(), 100);
    }
    update(state) {
        const next = getRivePlayerState({ ...this.state.getValue(), ...state });
        this.state.next(next);
    }
    initAnimation(name) {
        if (!this.service.rive)
            throw new Error('Could not load animation instance before rive');
        if (!this.canvas.artboard)
            throw new Error('Could not load animation instance before artboard');
        const ref = typeof name === 'string'
            ? this.canvas.artboard.animationByName(name)
            : this.canvas.artboard.animationByIndex(name);
        this.animation = ref;
        this.instance = new this.service.rive.LinearAnimationInstance(ref, this.canvas.artboard);
        this.startTime = getStart(this.instance);
        this.endTime = getEnd(this.instance);
        this.load.emit(this.instance);
    }
    getFrame(state) {
        if (state.playing && this.service.frame) {
            return this.service.frame.pipe(map((time) => [state, time]));
        }
        else {
            return of(null);
        }
    }
    register(name) {
        this.sub?.unsubscribe(); // Stop subscribing to previous animation if any
        this.instance?.delete(); // Remove old instance if any
        // Update if time have changed from the input
        const onTimeChange = this.distance.pipe(filter(exist), distinctUntilChanged(), map(time => time - this.instance.time));
        // Update on frame change if playing
        const onFrameChange = this.state.pipe(switchMap((state) => this.getFrame(state)), filter(exist), map(([state, time]) => this.moveFrame(state, time)), tap((delta) => {
            this.zone.run(() => this.timeChange.emit(this.instance.time + delta));
        }));
        // Wait for canvas & animation to be loaded
        this.sub = this.canvas.onReady().pipe(map(() => this.initAnimation(name)), switchMap(() => merge(onTimeChange, onFrameChange))).subscribe((delta) => this.applyChange(delta));
    }
    moveFrame(state, time) {
        if (!this.instance)
            throw new Error('Could not load animation instance before running it');
        if (!this.animation)
            throw new Error('Could not load animation before running it');
        const { speed, autoreset, mode } = state;
        // Default mode, don't apply any logic
        if (!mode)
            return time / 1000 * speed;
        let delta = (time / 1000) * speed;
        // Round to avoid JS error on division
        const start = this.startTime ?? 0;
        const end = this.endTime ?? (this.instance.duration / this.instance.fps);
        const currentTime = round(this.instance.time);
        // When player hit floor
        if (currentTime + delta < start) {
            if (mode === 'loop' && speed < 0 && end) {
                delta = end - currentTime; // end - currentTime
            }
            else if (mode === 'ping-pong') {
                delta = -delta;
                this.update({ speed: -speed });
                this.zone.run(() => this.speedChange.emit(-speed));
            }
            else if (mode === 'one-shot') {
                this.update({ playing: false });
                this.zone.run(() => this.playChange.emit(false));
                delta = start - currentTime;
            }
        }
        // Put before "hit last frame" else currentTime + delta > end
        if (mode === 'one-shot' && autoreset) {
            if (speed > 0 && currentTime === end) {
                delta = start - end;
            }
            if (speed < 0 && currentTime === start) {
                delta = end - start;
            }
        }
        // When player hit last frame
        if (currentTime + delta > end) {
            if (mode === 'loop' && speed > 0) {
                delta = start - currentTime;
            }
            else if (mode === 'ping-pong') {
                delta = -delta;
                this.update({ speed: -speed });
                this.zone.run(() => this.speedChange.emit(-speed));
            }
            else if (mode === 'one-shot') {
                this.update({ playing: false });
                this.zone.run(() => this.playChange.emit(false));
                delta = end - currentTime;
            }
        }
        return delta;
    }
    applyChange(delta) {
        // We need to use requestAnimationFrame when delta is changed by the time
        this.service.rive?.requestAnimationFrame(() => {
            if (!this.instance)
                throw new Error('Could not load animation instance before running it');
            this.canvas.draw(this.instance, delta, this.state.getValue().mix);
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RivePlayer, deps: [{ token: i0.NgZone }, { token: i1.RiveCanvas }, { token: i2.RiveService }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.1.4", type: RivePlayer, isStandalone: true, selector: "riv-player, [rivPlayer]", inputs: { name: "name", index: "index", mix: "mix", speed: "speed", play: "play", time: "time", autoreset: "autoreset", mode: "mode" }, outputs: { load: "load", timeChange: "timeChange", playChange: "playChange", speedChange: "speedChange" }, exportAs: ["rivPlayer"], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.4", ngImport: i0, type: RivePlayer, decorators: [{
            type: Directive,
            args: [{
                    selector: 'riv-player, [rivPlayer]',
                    exportAs: 'rivPlayer',
                    standalone: true
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: i1.RiveCanvas }, { type: i2.RiveService }]; }, propDecorators: { name: [{
                type: Input
            }], index: [{
                type: Input
            }], mix: [{
                type: Input
            }], speed: [{
                type: Input
            }], play: [{
                type: Input
            }], time: [{
                type: Input
            }], autoreset: [{
                type: Input
            }], mode: [{
                type: Input
            }], load: [{
                type: Output
            }], timeChange: [{
                type: Output
            }], playChange: [{
                type: Output
            }], speedChange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZy1yaXZlL3NyYy9saWIvcGxheWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQWEsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25GLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQzs7OztBQWN4QyxTQUFTLGtCQUFrQixDQUFDLFFBQWtDLEVBQUU7SUFDOUQsT0FBTztRQUNMLEtBQUssRUFBRSxDQUFDO1FBQ1IsT0FBTyxFQUFFLEtBQUs7UUFDZCxHQUFHLEVBQUUsQ0FBQztRQUNOLFNBQVMsRUFBRSxLQUFLO1FBQ2hCLEdBQUcsS0FBSztLQUNULENBQUE7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLFVBQVUsQ0FBQyxLQUFhLEVBQUUsR0FBVztJQUNuRCxPQUFPLEtBQUssR0FBRyxHQUFHLENBQUM7QUFDckIsQ0FBQztBQUVELE1BQU0sVUFBVSxLQUFLLENBQUMsS0FBYTtJQUNqQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQztBQUM5RCxDQUFDO0FBRUQsU0FBUyxLQUFLLENBQUksQ0FBdUI7SUFDdkMsT0FBTyxDQUFDLEtBQUssU0FBUyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUM7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QjtnSkFnQkssSUFBSTtzQkFEUCxLQUFLO2dCQWFGLEtBQUs7c0JBRFIsS0FBSztnQkFXRixHQUFHO3NCQUROLEtBQUs7Z0JBV0YsS0FBSztzQkFEUixLQUFLO2dCQVNPLElBQUk7c0JBQWhCLEtBQUs7Z0JBYUYsSUFBSTtzQkFEUCxLQUFLO2dCQVdGLFNBQVM7c0JBRFosS0FBSztnQkFpQkYsSUFBSTtzQkFEUCxLQUFLO2dCQVNJLElBQUk7c0JBQWIsTUFBTTtnQkFDRyxVQUFVO3NCQUFuQixNQUFNO2dCQUNHLFVBQVU7c0JBQW5CLE1BQU07Z0JBQ0csV0FBVztzQkFBcEIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgTmdab25lLCBPbkRlc3Ryb3ksIE91dHB1dCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgbWVyZ2UsIG9mLCBTdWJzY3JpcHRpb24gfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCBtYXAsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IFJpdmVDYW52YXMgfSBmcm9tICcuL2NhbnZhcyc7XHJcbmltcG9ydCB7IFJpdmVTZXJ2aWNlIH0gZnJvbSBcIi4vc2VydmljZVwiO1xyXG5pbXBvcnQgeyBMaW5lYXJBbmltYXRpb25JbnN0YW5jZSwgTGluZWFyQW5pbWF0aW9uIH0gZnJvbSBcIkByaXZlLWFwcC9jYW52YXMtYWR2YW5jZWRcIjtcclxuXHJcbmludGVyZmFjZSBSaXZlUGxheWVyU3RhdGUge1xyXG4gIHNwZWVkOiBudW1iZXI7XHJcbiAgcGxheWluZzogYm9vbGVhbjtcclxuICAvKiogV2VpZ2h0IG9mIHRoaXMgYW5pbWF0aW9uIG92ZXIgYW5vdGhlciAqL1xyXG4gIG1peDogbnVtYmVyO1xyXG4gIC8qKiBSZXNldCBhdXRvbWF0aWNhbGx5IHRvIDAgd2hlbiBwbGF5IGlzIGRvd24gaWYgbW9kZSBpcyBcIm9uZS1zaG90XCIgKi9cclxuICBhdXRvcmVzZXQ6IGJvb2xlYW47XHJcbiAgLyoqIG92ZXJyaWRlIG1vZGUgb2YgdGhlIGFuaW1hdGlvbiAqL1xyXG4gIG1vZGU/OiAnbG9vcCcgfCAncGluZy1wb25nJyB8ICdvbmUtc2hvdCc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFJpdmVQbGF5ZXJTdGF0ZShzdGF0ZTogUGFydGlhbDxSaXZlUGxheWVyU3RhdGU+ID0ge30pOiBSaXZlUGxheWVyU3RhdGUge1xyXG4gIHJldHVybiB7XHJcbiAgICBzcGVlZDogMSxcclxuICAgIHBsYXlpbmc6IGZhbHNlLFxyXG4gICAgbWl4OiAxLFxyXG4gICAgYXV0b3Jlc2V0OiBmYWxzZSxcclxuICAgIC4uLnN0YXRlXHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZnJhbWVUb1NlYyhmcmFtZTogbnVtYmVyLCBmcHM6IG51bWJlcikge1xyXG4gIHJldHVybiBmcmFtZSAvIGZwcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJvdW5kKHZhbHVlOiBudW1iZXIpIHtcclxuICByZXR1cm4gTWF0aC5yb3VuZCgodmFsdWUgKyBOdW1iZXIuRVBTSUxPTikgKiAxMDAwMCkgLyAxMDAwMDtcclxufVxyXG5cclxuZnVuY3Rpb24gZXhpc3Q8VD4odjogVCB8IHVuZGVmaW5lZCB8IG51bGwpOiB2IGlzIFQge1xyXG4gIHJldHVybiB2ICE9PSB1bmRlZmluZWQgJiYgdiAhPT0gbnVsbDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0U3RhcnQoYW5pbWF0aW9uOiBMaW5lYXJBbmltYXRpb25JbnN0YW5jZSkge1xyXG4gIGlmICghYW5pbWF0aW9uLndvcmtTdGFydCB8fCBhbmltYXRpb24ud29ya1N0YXJ0ID09PSAtMSkgcmV0dXJuIDA7XHJcbiAgcmV0dXJuIHJvdW5kKGFuaW1hdGlvbi53b3JrU3RhcnQgLyBhbmltYXRpb24uZnBzKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RW5kKGFuaW1hdGlvbjogTGluZWFyQW5pbWF0aW9uSW5zdGFuY2UpIHtcclxuICBjb25zdCBlbmQgPSAoIWFuaW1hdGlvbi53b3JrRW5kIHx8YW5pbWF0aW9uLndvcmtFbmQgPT09IC0xKSA/IGFuaW1hdGlvbi5kdXJhdGlvbiA6IGFuaW1hdGlvbi53b3JrRW5kO1xyXG4gIHJldHVybiByb3VuZChlbmQgLyBhbmltYXRpb24uZnBzKTtcclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ3Jpdi1wbGF5ZXIsIFtyaXZQbGF5ZXJdJyxcclxuICAgIGV4cG9ydEFzOiAncml2UGxheWVyJyxcclxuICAgIHN0YW5kYWxvbmU6IHRydWVcclxufSlcclxuZXhwb3J0IGNsYXNzIFJpdmVQbGF5ZXIgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgc3ViPzogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgYW5pbWF0aW9uPzogTGluZWFyQW5pbWF0aW9uO1xyXG4gIHByaXZhdGUgaW5zdGFuY2U/OiBMaW5lYXJBbmltYXRpb25JbnN0YW5jZTtcclxuXHJcbiAgc3RhcnRUaW1lPzogbnVtYmVyO1xyXG4gIGVuZFRpbWU/OiBudW1iZXI7XHJcbiAgZGlzdGFuY2UgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG51bWJlciB8IG51bGw+KG51bGwpO1xyXG4gIHN0YXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxSaXZlUGxheWVyU3RhdGU+KGdldFJpdmVQbGF5ZXJTdGF0ZSgpKTtcclxuXHJcbiAgLyoqXHJcbiAgICogTmFtZSBvZiB0aGUgcml2ZSBhbmltYXRpb24gaW4gdGhlIGN1cnJlbnQgQXJ0Ym9hcmRcclxuICAgKiBFaXRoZXIgdXNlIG5hbWUgb3IgaW5kZXggdG8gc2VsZWN0IGFuIGFuaW1hdGlvblxyXG4gICAqL1xyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IG5hbWUobmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkIHwgbnVsbCkge1xyXG4gICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgcmV0dXJuO1xyXG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgdGhpcy5yZWdpc3RlcihuYW1lKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5kZXggb2YgdGhlIHJpdmUgYW5pbWF0aW9uIGluIHRoZSBjdXJyZW50IEFydGJvYXJkIFxyXG4gICAqIEVpdGhlciB1c2UgaW5kZXggb2YgbmFtZSB0byBzZWxlY3QgYW4gYW5pbWF0aW9uXHJcbiAgICovXHJcbiAgQElucHV0KClcclxuICBzZXQgaW5kZXgodmFsdWU6IG51bWJlciB8IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwpIHtcclxuICAgIGNvbnN0IGluZGV4ID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlSW50KHZhbHVlKSA6IHZhbHVlO1xyXG4gICAgaWYgKHR5cGVvZiBpbmRleCAhPT0gJ251bWJlcicpIHJldHVybjtcclxuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgIHRoaXMucmVnaXN0ZXIoaW5kZXgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKiogVGhlIG1peCBvZiB0aGlzIGFuaW1hdGlvbiBpbiB0aGUgY3VycmVudCBhcmJvYXJkICovXHJcbiAgQElucHV0KClcclxuICBzZXQgbWl4KHZhbHVlOiBudW1iZXIgfCBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsKSB7XHJcbiAgICBjb25zdCBtaXggPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VGbG9hdCh2YWx1ZSkgOiB2YWx1ZTsgXHJcbiAgICBpZiAobWl4ICYmIG1peCA+PSAwICYmIG1peCA8PSAxKSB0aGlzLnVwZGF0ZSh7IG1peCB9KTtcclxuICB9XHJcbiAgZ2V0IG1peCgpIHtcclxuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldFZhbHVlKCkubWl4O1xyXG4gIH1cclxuXHJcbiAgLyoqIE11bHRpcGxpY2F0b3Igb2YgdGhlIHNwZWVkIGZvciB0aGUgYW5pbWF0aW9uICovXHJcbiAgQElucHV0KClcclxuICBzZXQgc3BlZWQodmFsdWU6IG51bWJlciB8IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwpIHtcclxuICAgIGNvbnN0IHNwZWVkID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlRmxvYXQodmFsdWUpIDogdmFsdWU7XHJcbiAgICBpZiAodHlwZW9mIHNwZWVkID09PSAnbnVtYmVyJykgdGhpcy51cGRhdGUoeyBzcGVlZCB9KTtcclxuICB9XHJcbiAgZ2V0IHNwZWVkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0VmFsdWUoKS5zcGVlZDtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgpIHNldCBwbGF5KHBsYXlpbmc6IGJvb2xlYW4gfCAnJyB8IHVuZGVmaW5lZCB8IG51bGwpIHtcclxuICAgIGlmIChwbGF5aW5nID09PSB0cnVlIHx8IHBsYXlpbmcgPT09ICcnKSB7XHJcbiAgICAgIHRoaXMudXBkYXRlKHsgcGxheWluZzogdHJ1ZSB9KTtcclxuICAgIH0gZWxzZSBpZiAocGxheWluZyA9PT0gZmFsc2UpIHtcclxuICAgICAgdGhpcy51cGRhdGUoeyBwbGF5aW5nOiBmYWxzZSB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgZ2V0IHBsYXkoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5nZXRWYWx1ZSgpLnBsYXlpbmc7XHJcbiAgfVxyXG5cclxuICBcclxuICBASW5wdXQoKVxyXG4gIHNldCB0aW1lKHZhbHVlOiBudW1iZXIgfCBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsKSB7XHJcbiAgICBjb25zdCB0aW1lID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlRmxvYXQodmFsdWUpIDogdmFsdWU7XHJcbiAgICBpZiAodHlwZW9mIHRpbWUgPT09ICdudW1iZXInKSB0aGlzLmRpc3RhbmNlLm5leHQodGltZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAZGVwcmVjYXRlZCBUaGlzIHdpbGwgYmUgcmVtb3ZlZFxyXG4gICAqIENvbnNpZGVyIHVzaW5nIFN0YXRlTWFjaGluZSBpbnN0ZWFkXHJcbiAgICovXHJcbiAgQElucHV0KClcclxuICBzZXQgYXV0b3Jlc2V0KGF1dG9yZXNldDogYm9vbGVhbiB8ICcnIHwgdW5kZWZpbmVkIHwgbnVsbCkge1xyXG4gICAgaWYgKGF1dG9yZXNldCA9PT0gdHJ1ZSB8fCBhdXRvcmVzZXQgPT09ICcnKSB7XHJcbiAgICAgIHRoaXMudXBkYXRlKHsgYXV0b3Jlc2V0OiB0cnVlIH0pO1xyXG4gICAgfSBlbHNlIGlmIChhdXRvcmVzZXQgPT09IGZhbHNlKSB7XHJcbiAgICAgIHRoaXMudXBkYXRlKHsgYXV0b3Jlc2V0OiBmYWxzZSB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgZ2V0IGF1dG9yZXNldCgpIHtcclxuICAgIHJldHVybiB0aGlzLnN0YXRlLmdldFZhbHVlKCkuYXV0b3Jlc2V0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQGRlcHJlY2F0ZWQgVGhpcyB3aWxsIGJlIHJlbW92ZWRcclxuICAgKiBDb25zaWRlciB1c2luZyBTdGF0ZU1hY2hpbmUgaW5zdGVhZFxyXG4gICAqL1xyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IG1vZGUobW9kZTogUml2ZVBsYXllclN0YXRlWydtb2RlJ10pIHtcclxuICAgIGlmIChtb2RlKSB0aGlzLnVwZGF0ZSh7IG1vZGUgfSk7XHJcbiAgfVxyXG4gIGdldCBtb2RlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0VmFsdWUoKS5tb2RlO1xyXG4gIH1cclxuXHJcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1vdXRwdXQtbmF0aXZlXHJcbiAgQE91dHB1dCgpIGxvYWQgPSBuZXcgRXZlbnRFbWl0dGVyPExpbmVhckFuaW1hdGlvbkluc3RhbmNlPigpO1xyXG4gIEBPdXRwdXQoKSB0aW1lQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XHJcbiAgQE91dHB1dCgpIHBsYXlDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XHJcbiAgQE91dHB1dCgpIHNwZWVkQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXHJcbiAgICBwcml2YXRlIGNhbnZhczogUml2ZUNhbnZhcyxcclxuICAgIHByaXZhdGUgc2VydmljZTogUml2ZVNlcnZpY2UsXHJcbiAgKSB7fVxyXG5cclxuICBcclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuc3ViPy51bnN1YnNjcmliZSgpO1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmluc3RhbmNlPy5kZWxldGUoKSwgMTAwKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlKHN0YXRlOiBQYXJ0aWFsPFJpdmVQbGF5ZXJTdGF0ZT4pIHtcclxuICAgIGNvbnN0IG5leHQgPSBnZXRSaXZlUGxheWVyU3RhdGUoey4uLnRoaXMuc3RhdGUuZ2V0VmFsdWUoKSwgLi4uc3RhdGUgfSlcclxuICAgIHRoaXMuc3RhdGUubmV4dChuZXh0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdEFuaW1hdGlvbihuYW1lOiBzdHJpbmcgfCBudW1iZXIpIHtcclxuICAgIGlmICghdGhpcy5zZXJ2aWNlLnJpdmUpIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGxvYWQgYW5pbWF0aW9uIGluc3RhbmNlIGJlZm9yZSByaXZlJyk7XHJcbiAgICBpZiAoIXRoaXMuY2FudmFzLmFydGJvYXJkKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIGFuaW1hdGlvbiBpbnN0YW5jZSBiZWZvcmUgYXJ0Ym9hcmQnKTtcclxuICAgIFxyXG4gICAgY29uc3QgcmVmID0gdHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnXHJcbiAgICA/IHRoaXMuY2FudmFzLmFydGJvYXJkLmFuaW1hdGlvbkJ5TmFtZShuYW1lKVxyXG4gICAgOiB0aGlzLmNhbnZhcy5hcnRib2FyZC5hbmltYXRpb25CeUluZGV4KG5hbWUpO1xyXG4gICAgXHJcbiAgICB0aGlzLmFuaW1hdGlvbiA9IHJlZjtcclxuICAgIHRoaXMuaW5zdGFuY2UgPSBuZXcgdGhpcy5zZXJ2aWNlLnJpdmUuTGluZWFyQW5pbWF0aW9uSW5zdGFuY2UocmVmLCB0aGlzLmNhbnZhcy5hcnRib2FyZCk7XHJcbiAgICB0aGlzLnN0YXJ0VGltZSA9IGdldFN0YXJ0KHRoaXMuaW5zdGFuY2UpO1xyXG4gICAgdGhpcy5lbmRUaW1lID0gZ2V0RW5kKHRoaXMuaW5zdGFuY2UpO1xyXG4gICAgXHJcbiAgICB0aGlzLmxvYWQuZW1pdCh0aGlzLmluc3RhbmNlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RnJhbWUoc3RhdGU6IFJpdmVQbGF5ZXJTdGF0ZSkge1xyXG4gICAgaWYgKHN0YXRlLnBsYXlpbmcgJiYgdGhpcy5zZXJ2aWNlLmZyYW1lKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnNlcnZpY2UuZnJhbWUucGlwZShtYXAoKHRpbWUpID0+IFtzdGF0ZSwgdGltZV0gYXMgY29uc3QpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBvZihudWxsKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlcihuYW1lOiBzdHJpbmcgfCBudW1iZXIpIHtcclxuICAgIHRoaXMuc3ViPy51bnN1YnNjcmliZSgpOyAgLy8gU3RvcCBzdWJzY3JpYmluZyB0byBwcmV2aW91cyBhbmltYXRpb24gaWYgYW55XHJcbiAgICB0aGlzLmluc3RhbmNlPy5kZWxldGUoKTsgIC8vIFJlbW92ZSBvbGQgaW5zdGFuY2UgaWYgYW55XHJcblxyXG4gICAgLy8gVXBkYXRlIGlmIHRpbWUgaGF2ZSBjaGFuZ2VkIGZyb20gdGhlIGlucHV0XHJcbiAgICBjb25zdCBvblRpbWVDaGFuZ2UgPSB0aGlzLmRpc3RhbmNlLnBpcGUoXHJcbiAgICAgIGZpbHRlcihleGlzdCksXHJcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXHJcbiAgICAgIG1hcCh0aW1lID0+IHRpbWUgLSB0aGlzLmluc3RhbmNlIS50aW1lKSxcclxuICAgICk7XHJcblxyXG4gICAgLy8gVXBkYXRlIG9uIGZyYW1lIGNoYW5nZSBpZiBwbGF5aW5nXHJcbiAgICBjb25zdCBvbkZyYW1lQ2hhbmdlID0gdGhpcy5zdGF0ZS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKHN0YXRlKSA9PiB0aGlzLmdldEZyYW1lKHN0YXRlKSksXHJcbiAgICAgIGZpbHRlcihleGlzdCksXHJcbiAgICAgIG1hcCgoW3N0YXRlLCB0aW1lXSkgPT4gdGhpcy5tb3ZlRnJhbWUoc3RhdGUsIHRpbWUpKSxcclxuICAgICAgdGFwKChkZWx0YSkgPT4ge1xyXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gdGhpcy50aW1lQ2hhbmdlLmVtaXQodGhpcy5pbnN0YW5jZSEudGltZSArIGRlbHRhKSlcclxuICAgICAgfSlcclxuICAgICk7XHJcblxyXG4gICAgLy8gV2FpdCBmb3IgY2FudmFzICYgYW5pbWF0aW9uIHRvIGJlIGxvYWRlZFxyXG4gICAgdGhpcy5zdWIgPSB0aGlzLmNhbnZhcy5vblJlYWR5KCkucGlwZShcclxuICAgICAgbWFwKCgpID0+IHRoaXMuaW5pdEFuaW1hdGlvbihuYW1lKSksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiBtZXJnZShvblRpbWVDaGFuZ2UsIG9uRnJhbWVDaGFuZ2UpKVxyXG4gICAgKS5zdWJzY3JpYmUoKGRlbHRhKSA9PiB0aGlzLmFwcGx5Q2hhbmdlKGRlbHRhKSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG1vdmVGcmFtZShzdGF0ZTogUml2ZVBsYXllclN0YXRlLCB0aW1lOiBudW1iZXIpIHtcclxuICAgIGlmICghdGhpcy5pbnN0YW5jZSkgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgbG9hZCBhbmltYXRpb24gaW5zdGFuY2UgYmVmb3JlIHJ1bm5pbmcgaXQnKTtcclxuICAgIGlmICghdGhpcy5hbmltYXRpb24pIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGxvYWQgYW5pbWF0aW9uIGJlZm9yZSBydW5uaW5nIGl0Jyk7XHJcbiAgICBjb25zdCB7IHNwZWVkLCBhdXRvcmVzZXQsIG1vZGUgfSA9IHN0YXRlO1xyXG4gICAgLy8gRGVmYXVsdCBtb2RlLCBkb24ndCBhcHBseSBhbnkgbG9naWNcclxuICAgIGlmICghbW9kZSkgcmV0dXJuIHRpbWUgLyAxMDAwICogc3BlZWQ7XHJcblxyXG4gICAgbGV0IGRlbHRhID0gKHRpbWUgLyAxMDAwKSAqIHNwZWVkO1xyXG4gICAgXHJcbiAgICAvLyBSb3VuZCB0byBhdm9pZCBKUyBlcnJvciBvbiBkaXZpc2lvblxyXG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLnN0YXJ0VGltZSA/PyAwO1xyXG4gICAgY29uc3QgZW5kID0gdGhpcy5lbmRUaW1lID8/ICh0aGlzLmluc3RhbmNlLmR1cmF0aW9uIC8gdGhpcy5pbnN0YW5jZS5mcHMpO1xyXG4gICAgY29uc3QgY3VycmVudFRpbWUgPSByb3VuZCh0aGlzLmluc3RhbmNlLnRpbWUpO1xyXG5cclxuICAgIC8vIFdoZW4gcGxheWVyIGhpdCBmbG9vclxyXG4gICAgaWYgKGN1cnJlbnRUaW1lICsgZGVsdGEgPCBzdGFydCkge1xyXG4gICAgICBpZiAobW9kZSA9PT0gJ2xvb3AnICYmIHNwZWVkIDwgMCAmJiBlbmQpIHtcclxuICAgICAgICBkZWx0YSA9IGVuZCAtIGN1cnJlbnRUaW1lOyAvLyBlbmQgLSBjdXJyZW50VGltZVxyXG4gICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdwaW5nLXBvbmcnKSB7XHJcbiAgICAgICAgZGVsdGEgPSAtZGVsdGE7XHJcbiAgICAgICAgdGhpcy51cGRhdGUoeyBzcGVlZDogLXNwZWVkIH0pO1xyXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gdGhpcy5zcGVlZENoYW5nZS5lbWl0KC1zcGVlZCkpO1xyXG4gICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdvbmUtc2hvdCcpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZSh7IHBsYXlpbmc6IGZhbHNlIH0pO1xyXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gdGhpcy5wbGF5Q2hhbmdlLmVtaXQoZmFsc2UpKTtcclxuICAgICAgICBkZWx0YSA9IHN0YXJ0IC0gY3VycmVudFRpbWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBQdXQgYmVmb3JlIFwiaGl0IGxhc3QgZnJhbWVcIiBlbHNlIGN1cnJlbnRUaW1lICsgZGVsdGEgPiBlbmRcclxuICAgIGlmIChtb2RlID09PSAnb25lLXNob3QnICYmIGF1dG9yZXNldCkge1xyXG4gICAgICBpZiAoc3BlZWQgPiAwICYmIGN1cnJlbnRUaW1lID09PSBlbmQpIHtcclxuICAgICAgICBkZWx0YSA9IHN0YXJ0IC0gZW5kO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChzcGVlZCA8IDAgJiYgY3VycmVudFRpbWUgPT09IHN0YXJ0KSB7XHJcbiAgICAgICAgZGVsdGEgPSBlbmQgLSBzdGFydDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIFdoZW4gcGxheWVyIGhpdCBsYXN0IGZyYW1lXHJcbiAgICBpZiAoY3VycmVudFRpbWUgKyBkZWx0YSA+IGVuZCkge1xyXG4gICAgICBpZiAobW9kZSA9PT0gJ2xvb3AnICYmIHNwZWVkID4gMCkge1xyXG4gICAgICAgIGRlbHRhID0gc3RhcnQgLSBjdXJyZW50VGltZTtcclxuICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAncGluZy1wb25nJykge1xyXG4gICAgICAgIGRlbHRhID0gLWRlbHRhO1xyXG4gICAgICAgIHRoaXMudXBkYXRlKHsgc3BlZWQ6IC1zcGVlZCB9KTtcclxuICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHRoaXMuc3BlZWRDaGFuZ2UuZW1pdCgtc3BlZWQpKTtcclxuICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnb25lLXNob3QnKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGUoeyBwbGF5aW5nOiBmYWxzZSB9KTtcclxuICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHRoaXMucGxheUNoYW5nZS5lbWl0KGZhbHNlKSk7XHJcbiAgICAgICAgZGVsdGEgPSBlbmQgLSBjdXJyZW50VGltZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIFxyXG4gICAgcmV0dXJuIGRlbHRhO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhcHBseUNoYW5nZShkZWx0YTogbnVtYmVyKSB7XHJcbiAgICAvLyBXZSBuZWVkIHRvIHVzZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgd2hlbiBkZWx0YSBpcyBjaGFuZ2VkIGJ5IHRoZSB0aW1lXHJcbiAgICB0aGlzLnNlcnZpY2Uucml2ZT8ucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLmluc3RhbmNlKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIGFuaW1hdGlvbiBpbnN0YW5jZSBiZWZvcmUgcnVubmluZyBpdCcpO1xyXG4gICAgICB0aGlzLmNhbnZhcy5kcmF3KHRoaXMuaW5zdGFuY2UsIGRlbHRhLCB0aGlzLnN0YXRlLmdldFZhbHVlKCkubWl4KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbn0iXX0=